# 力学 Krylov 收敛专项调参报告（2026-02-11）

## 1. 目标

针对 `mg_coupled_pf/mechanics.py` 中力学平衡求解，完成以下专项调参：

- 提升 Krylov 收敛率（避免频繁回退）
- 保持数值稳健（不引入发散）
- 给出可复现配置与测试结论

---

## 2. 实施项

### 2.1 Krylov 内核升级

已实现：

- 新增 `GMRES(restart)+Jacobi` 作为默认 Krylov 方法
- 保留 `BiCGStab+Jacobi` 作为可选对照
- `hybrid_cg_relax` 继续保留“失败回退到松弛法”机制

配置项（`numerics`）：

- `mechanics_krylov_method: gmres|bicgstab`
- `mechanics_gmres_restart`
- `mechanics_gmres_max_restarts`
- `mechanics_cg_max_iters`（作为 Krylov 总迭代预算）
- `mechanics_cg_tol_abs`
- `mechanics_cg_tol_rel`
- `mechanics_cg_diag_shift`

### 2.2 失败冷却重试机制

新增机制：

- 连续失败达到阈值后，进入 Krylov 冷却窗口，仅走回退松弛；
- 冷却结束后自动重试 Krylov，不会永久关闭。

配置项：

- `mechanics_krylov_fail_streak_to_pause`
- `mechanics_krylov_pause_steps`

---

## 3. 已写入的默认调参（notch_case）

`configs/notch_case.yaml` 中 `numerics` 已加入：

- `mechanics_solver: hybrid_cg_relax`
- `mechanics_krylov_method: gmres`
- `mechanics_cg_max_iters: 120`
- `mechanics_cg_tol_abs: 5.0`
- `mechanics_cg_tol_rel: 0.005`
- `mechanics_cg_diag_shift: 1.0e-6`
- `mechanics_gmres_restart: 24`
- `mechanics_gmres_max_restarts: 6`
- `mechanics_krylov_fail_streak_to_pause: 3`
- `mechanics_krylov_pause_steps: 30`

---

## 4. 对照测试结果

结果文件：

- `artifacts/reports/krylov_tuning_report_20260211.json`

对照工况（CPU，`96x64`，`24` 步）：

1. `relaxation`（基线）
2. `hybrid_cg_relax + gmres`
3. `hybrid_cg_relax + bicgstab`

关键指标：

- `hybrid_gmres`
  - `mech_cg_converged = 48`
  - `mech_cg_failed = 0`
  - 平衡残差 `mean_div_residual = 0.05108`
- `relaxation`
  - 平衡残差 `mean_div_residual = 0.36746`
- `hybrid_bicgstab`
  - `mech_cg_converged = 0`
  - `mech_cg_failed = 6`
  - 残差与基线接近（主要依赖回退）

结论：

- **收敛性**：GMRES 路线显著优于 BiCGStab，且在该工况达到 100% Krylov 收敛。  
- **平衡残差**：GMRES 解的力学平衡残差显著更低（约 7.2 倍改善）。  
- **耗时**：本工况下 GMRES 比纯松弛慢（更高求解精度导致），但结果更接近平衡解。  

---

## 5. 测试与回归

全量测试：

```powershell
.\.venv_gpu\Scripts\python -m pytest -q tests
```

结果：

- `12 passed`

新增测试：

- `test_mechanics_gmres_hybrid_converges_short_run`

---

## 6. 使用建议

1. 若优先“收敛与平衡精度”  
   使用 `hybrid_cg_relax + gmres`（当前默认）。

2. 若优先“极限速度”且可接受较粗平衡  
   可切换 `mechanics_solver: relaxation`。

3. 若要继续提升“又快又稳”  
   下一步建议做：
   - 更强预条件器（块预条件/近似 Schur）
   - 外层非线性-线性解耦步长自适应
   - 结合 `mechanics_use_ml_initial_guess` 降低 Krylov 迭代次数

