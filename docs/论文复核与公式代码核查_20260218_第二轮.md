# 论文复核与公式代码核查（第二轮，2026-02-18）

## 1. 目标与结论

本轮针对 `mg_coupled_pf/` 进行了“论文公式 -> 代码实现”的逐项复核，并执行了可复现实算与可视化输出。  
结论：

- 主方程结构（Allen-Cahn 非守恒序参量、化学势一致的浓度扩散、准静态力学平衡、CP-孪晶耦合）与当前文献主流写法一致。
- 核心实现较前期版本已显著收敛到一致口径：界面厚度定标、平面应力各向异性消元、固相应力驱动腐蚀、CP 分相硬化、塑性速率耦合等关键点已落地。
- 仍不能宣称“绝对零偏差”。当前模型仍属于“小应变 + mobility-only 可选耦合 + 2D 投影”工程框架，适用于高保真数值研究与方法开发，但在“严格有限应变孪晶 + 全变分电化学-力学闭合”方向仍有可升级空间。

## 2. 论文基线（本轮重点对照）

- Chen, *Phase-Field Models for Microstructure Evolution*, Annual Review of Materials Research, 2002.  
  链接：<https://www.annualreviews.org/content/journals/10.1146/annurev.matsci.32.112001.132041>
- Kovacevic et al., *Phase-field modeling of pitting and mechanically-assisted corrosion of Mg alloys for biomedical applications*, Acta Biomaterialia, 2023.  
  链接：<https://doi.org/10.1016/j.actbio.2023.04.011>
- Cui et al., *Phase field modelling of dissolution-driven stress corrosion cracking*, JMPS, 2021.  
  链接：<https://doi.org/10.1016/j.jmps.2020.104254>
- Hu et al., *Coupled crystal plasticity-phase field simulation of twin-twin interaction in magnesium*, IJMS, 2024.  
  链接：<https://doi.org/10.1016/j.ijmecsci.2024.109734>
- Li et al., *Fourier Neural Operator*, 2020.  
  链接：<https://arxiv.org/abs/2010.08895>
- Li et al., *Physics-Informed Neural Operator*, 2021.  
  链接：<https://arxiv.org/abs/2111.03794>
- Li et al., *Learning Preconditioners for Conjugate Gradient PDE Solvers*, ICML 2023.  
  链接：<https://proceedings.mlr.press/v202/li23e.html>
- Zhao et al., *Phase-Field DeepONet*, CMAME, 2024.  
  链接：<https://doi.org/10.1016/j.cma.2023.116475>
- Yang et al., *U-AFNO hybrid adaptive operator for phase-field acceleration*, npj Comput Mater, 2025.  
  链接：<https://www.nature.com/articles/s41524-024-01488-z>

## 3. 公式-代码一致性核查清单

### 3.1 腐蚀相场（Allen-Cahn）

- 理论目标：非守恒序参量应为  
  `phi_t = -L_phi * (dF/dphi)`，梯度项应表现为 `+L_phi*kappa*laplacian(phi)`（而不是 `div(L*kappa*grad(phi))`）。
- 实现核查：
  - `mg_coupled_pf/simulator.py:2050`
  - `mg_coupled_pf/simulator.py:2065`
  - `mg_coupled_pf/simulator.py:2081`
- 结论：当前实现已采用 `L*laplacian` 结构与 IMEX-L0 分裂，避免了早期 `grad(L)` 假项。

### 3.2 界面厚度与参数定标

- 理论目标：`gamma` 与 `omega/kappa` 需与双阱势口径一致。
- 实现核查：
  - `mg_coupled_pf/operators.py:381`
  - `mg_coupled_pf/operators.py:387`
  - `mg_coupled_pf/simulator.py:1375`
  - `mg_coupled_pf/config.py:155`
- 结论：已支持 `tanh_half_width` 与 `legacy` 双口径；默认是 `tanh_half_width`，并在配置中明确说明。

### 3.3 浓度方程（化学势一致）

- 理论目标：`mu = dF/dc`，扩散应按 `c_t = div(M*grad(mu))`。
- 实现核查：
  - `mg_coupled_pf/simulator.py:1046`
  - `mg_coupled_pf/simulator.py:1062`
  - `mg_coupled_pf/simulator.py:1068`
  - `mg_coupled_pf/simulator.py:1070`
- 结论：默认 `concentration_use_mu_form=true`，与 `F_chem` 口径一致。

### 3.4 非均匀网格 + 守恒通量离散

- 理论目标：非均匀网格下应采用守恒面通量或二阶局部格式，避免伪通量。
- 实现核查：
  - `mg_coupled_pf/operators.py:153`
  - `mg_coupled_pf/operators.py:269`
  - `mg_coupled_pf/simulator.py:958`
  - `mg_coupled_pf/simulator.py:1004`
- 结论：当前实现为二阶非均匀导数 + FV 扩散通量（harmonic mean）。

### 3.5 力学本构与平面应力/平面应变

- 理论目标：各向异性材料下平面应力应做 `sigma_zz=0` 消元（Schur 补），不能只“后处理置零”。
- 实现核查：
  - `mg_coupled_pf/mechanics.py:142`
  - `mg_coupled_pf/mechanics.py:155`
  - `mg_coupled_pf/mechanics.py:317`
- 结论：已新增平面应力消元系数提取，且与平面应变分支分离。

### 3.6 腐蚀应力驱动使用固相应力

- 理论目标：反应前沿驱动不应直接使用被液相门控后的应力。
- 实现核查：
  - `mg_coupled_pf/mechanics.py:387`
  - `mg_coupled_pf/simulator.py:1430`
  - `mg_coupled_pf/simulator.py:1434`
- 结论：当前默认使用 `sigma_h_solid` 驱动腐蚀 mobility（已修正）。

### 3.7 孪晶-塑性状态闭合

- 理论目标：若状态包含孪晶与塑性，必须保证硬化内变量、应变率量与更新路径一致。
- 实现核查：
  - `mg_coupled_pf/crystal_plasticity.py:129`
  - `mg_coupled_pf/crystal_plasticity.py:154`
  - `mg_coupled_pf/crystal_plasticity.py:238`
  - `mg_coupled_pf/simulator.py:835`
  - `mg_coupled_pf/simulator.py:2215`
  - `mg_coupled_pf/simulator.py:2229`
- 结论：已采用 `g_parent/g_twin` 分相硬化，且总等效速率支持 `slip + twin` 组合。

### 3.8 Surrogate 门控与物理约束

- 理论目标：门控至少应包含 PDE 残差、守恒和能量一致性（在可变分场景下）。
- 实现核查：
  - `mg_coupled_pf/simulator.py:630`
  - `mg_coupled_pf/simulator.py:733`
  - `mg_coupled_pf/simulator.py:560`
  - `mg_coupled_pf/simulator.py:805`
  - `mg_coupled_pf/config.py:339`
- 结论：门控链路已具备；但“全变分机械耦合”默认关闭时，能量门控应主要视作数值稳健性判据。

## 4. 本轮新增修复

为保证测试链路可复现，新增：

- `scripts/__init__.py`
- `tests/conftest.py`

用途：修复 `pytest` 对 `scripts.train_surrogate` 的导入路径问题。

## 5. 测试与可视化（本轮实跑）

### 5.1 命令

物理基线（禁用 ML）：

```bash
python scripts/run_notched_case.py --config configs/notch_case.yaml --disable-ml --total-time-s 0.2 --save-interval-s 0.05 --progress --progress-every 200 --device auto --audit-config --strict-audit
```

ML 打开对照（短时）：

```bash
python scripts/run_notched_case.py --config configs/notch_case.yaml --total-time-s 0.05 --save-interval-s 0.01 --progress --progress-every 100 --device auto --audit-config --strict-audit
```

全量测试：

```bash
pytest -q
```

### 5.2 结果

- `pytest`：`67 passed`
- 物理基线 0.2 s：
  - `n_steps=2000`
  - `wall_time_s≈129.39`
  - `device=cuda`
  - `config_audit: PASS`
- ML 短时 0.05 s：
  - `n_steps=500`
  - `wall_time_s≈31.22`
  - `ml_surrogate_attempt=8, accept=0, reject=8`（当前模型参数仍偏保守，门控正确拒绝）

### 5.3 可视化输出路径

- 云图/网格：
  - `artifacts/sim_notch/mg_notch_2d/final_clouds/phi_cloud.png`
  - `artifacts/sim_notch/mg_notch_2d/final_clouds/cMg_cloud.png`
  - `artifacts/sim_notch/mg_notch_2d/final_clouds/yeta_cloud.png`
  - `artifacts/sim_notch/mg_notch_2d/final_clouds/von_mises_cloud.png`
  - `artifacts/sim_notch/mg_notch_2d/grid/mesh_full.png`
  - `artifacts/sim_notch/mg_notch_2d/grid/mesh_notch_zoom.png`
- 过程图：
  - `artifacts/sim_notch/mg_notch_2d/figures/fields_000500.png`
  - `artifacts/sim_notch/mg_notch_2d/figures/fields_001000.png`
  - `artifacts/sim_notch/mg_notch_2d/figures/fields_002000.png`
- 诊断图（本轮新增）：
  - `artifacts/reports/theory_audit_20260218/history_diagnostics.png`
  - `artifacts/reports/theory_audit_20260218/residuals.png`

## 6. 仍需保持谨慎的近似项

以下属于“当前框架的已知近似”，不是程序错误，但会影响极限定量结论：

- 小应变孪晶转变应变（未切换到有限应变乘法分解）。
- 腐蚀应力耦合默认走 mobility-only（工程上可用，但非严格全变分闭合）。
- 2D 投影模型对 3D 真实多变体竞争的表达有限。

---

如需下一步做“第三轮严核”，建议直接按你指定的目标论文体系（例如固定为 Kovacevic 2023 + Cui 2021 + IJMS 2024）建立逐式符号对照表（公式编号到代码行号一一映射），并附上自动回归测试阈值。

