# 本轮优化与测试报告（20260212_183726）

## 1. 核心优化项

1. 新增力学专用 ML 初值器（Mechanics Warmstart）
- 新文件：`mg_coupled_pf/ml/mech_warmstart.py`
- 输入通道：`phi,c,eta,epspeq,epsp_xx,epsp_yy,epsp_xy`
- 输出：`ux,uy`
- 输出后强制施加位移边界约束，确保与力学求解器约束一致。

2. 在主求解流程接入 warmstart
- 文件：`mg_coupled_pf/simulator.py`
- 行为：当 `ml.enabled=true` 且 `ml.mechanics_warmstart_enabled=true` 且模型存在时，优先用 warmstart 生成 `ux/uy` 作为 Krylov 初值。
- 新增统计：
  - `mech_ml_initial_guess_mech_warmstart`
  - `mech_ml_initial_guess_surrogate`

3. 配置扩展
- 文件：`mg_coupled_pf/config.py`
- 新增参数：
  - `ml.mechanics_warmstart_enabled`
  - `ml.mechanics_warmstart_model_path`
  - `ml.mechanics_warmstart_hidden`
  - `ml.mechanics_warmstart_add_coord_features`

4. 新增训练脚本与测试
- 训练脚本：`scripts/train_mechanics_warmstart.py`
- 测试：`tests/test_mechanics_warmstart.py`

5. 文档更新
- `docs/中文操作手册.md`
- `docs/改进分析与执行记录.md`

## 2. 测试与验证

### 2.1 全量测试
命令：`python -m pytest -q`
结果：`35 passed`

### 2.2 力学初值器训练烟雾测试
命令：
`python scripts/train_mechanics_warmstart.py --config configs/notch_case.yaml --epochs 1 --batch-size 1 --max-samples 2 --device cpu --disable-torch-compile`
结果：成功输出模型 `artifacts/ml/mech_warmstart_latest.pt`

### 2.3 主流程联调烟雾测试
配置：
- `n_steps=2`
- 开启 `ml.enabled=true`
- 开启 `ml.mechanics_warmstart_enabled=true`
- 关闭 surrogate 模型（路径不存在）

结果统计：
- `mech_ml_initial_guess_used = 2`
- `mech_ml_initial_guess_mech_warmstart = 2`
- `mech_ml_initial_guess_surrogate = 0`

说明：warmstart 已被主流程实际使用。

## 3. 影响评估

- 正确性：不替代力学平衡方程，仍由 Krylov 迭代收敛保证；ML 仅用于“初值加速”。
- 稳定性：warmstart 输出已做 NaN/Inf 处理 + 边界硬约束投影。
- 性能预期：在复杂工况中可显著减少力学迭代次数（具体增益需按你的正式算例统计）。

## 4. 后续建议（下一轮）

1. 对 `torch.load` 增加 `weights_only=True` 兼容分支，消除安全警告。
2. 增加“迭代次数下降比例”自动统计（与 baseline 同算例对照）。
3. 引入学习型预条件器（第二阶段），在 warmstart 基础上进一步降低 Krylov 迭代步数。
