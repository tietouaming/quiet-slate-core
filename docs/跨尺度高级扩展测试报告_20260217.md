# 跨尺度高级扩展测试报告（2026-02-17）

## 1. 本轮目标

- 引入更先进的跨尺度模型架构（U-AFNO 混合主干 + 多保真校正）；
- 在“无实验数据、宏观高精度标签稀缺”条件下，建立可执行数据生成与评估流程；
- 提供科学的宏观正确性指标（PCI）并输出可视化报告；
- 将相场理论与全局参数整理为独立主文档，支持后续一键同步。

## 2. 新增代码与模块

- 核心模块：
  - `mg_coupled_pf/multiscale/advanced_models.py`
  - `mg_coupled_pf/multiscale/advanced_train.py`
  - `mg_coupled_pf/multiscale/physics_metrics.py`
  - `mg_coupled_pf/multiscale/visualization.py`
  - `mg_coupled_pf/multiscale/data_generation.py`
- 新增脚本：
  - `scripts/generate_physics_multiscale_cases.py`
  - `scripts/build_multifidelity_dataset.py`
  - `scripts/train_multiscale_advanced.py`
  - `scripts/evaluate_multiscale_advanced.py`
  - `scripts/export_phasefield_theory_params.py`
- 新增测试：
  - `tests/test_multifidelity_advanced.py`

## 3. 本轮测试命令与结果

### 3.1 全量回归测试

```powershell
$env:PYTHONPATH='.'; pytest -q
```

结果：
- `65 passed`

### 3.2 小规模真实流程试跑

1) 构建多保真数据集：

```powershell
python scripts/build_multifidelity_dataset.py `
  --cases-root artifacts/sim_notch `
  --pattern mg_notch_2d* `
  --horizon-steps 1 --frame-stride 4 `
  --max-samples-per-case 8 `
  --target-h 96 --target-w 96 `
  --low-target-h 48 --low-target-w 48 `
  --high-fidelity-ratio 0.35 --seed 7 `
  --output artifacts/ml/multifidelity_dataset_round2.npz
```

数据结果：
- `n_samples = 7`
- `high_ratio_actual = 0.142857`

2) 训练高级模型：

```powershell
python scripts/train_multiscale_advanced.py `
  --dataset artifacts/ml/multifidelity_dataset_round2.npz `
  --output-model artifacts/ml/multiscale_advanced_round2.pt `
  --epochs 8 --batch-size 4 --lr 3e-4 --train-split 0.8 `
  --model-name multifidelity_uafno `
  --width 32 --depth 2 --afno-blocks 2 --modes-x 12 --modes-y 10 `
  --device auto `
  --output-report-json artifacts/reports/multiscale_advanced_round2_report.json `
  --output-report-md artifacts/reports/multiscale_advanced_round2_report.md `
  --fig-dir artifacts/reports/multiscale_advanced_round2_figs
```

训练结果：
- `PCI = 0.6381`
- `RMSE = 455.0349`
- `MAE = 192.0233`
- `R2 = 0.2867`

3) 独立评估：

```powershell
python scripts/evaluate_multiscale_advanced.py `
  --model artifacts/ml/multiscale_advanced_round2.pt `
  --dataset artifacts/ml/multifidelity_dataset_round2.npz `
  --output artifacts/reports/multiscale_advanced_round2_eval.json `
  --device auto
```

评估结果（重点）：
- `overall_violation_rate = 0.0`
- `overall_monotonic_score = 0.0`
- `unc_coverage = 1.0`
- `physics_consistency_index = 0.6381`

## 4. 物理含义解释

- `overall_violation_rate=0.0`：本轮小样本下预测未超出基础物理边界（如体积分数与穿透比范围）。
- `overall_monotonic_score=0.0`：同算例时序趋势未学好，说明样本数量/时间跨度不足，当前模型仍偏“插值器”。
- `unc_coverage=1.0` 且区间宽度较大：不确定性覆盖充足但偏保守，模型在“高保真稀缺”时倾向给宽区间。
- `PCI≈0.64`：说明模型已具备可用的物理约束能力，但距离“高精度宏观替代模型”仍有明显提升空间。

## 5. 当前瓶颈与下一步

- 本轮小样本仅 `7` 条，不足以验证跨尺度泛化能力；
- 下一步建议：
  1. 先扩增到 `>=200` 样本并提高高保真占比（建议 `0.2~0.4`）；
  2. 开启更长 horizon（如 `ΔT=5~20` 快照步），强化时序趋势学习；
  3. 用 PCI + RMSE 双门槛筛选模型，并对失败区域触发主动补样。

## 6. 代码规模统计（当前工作区）

来源：`artifacts/reports/codebase_stats_round5.json`

- Python 有效代码（tracked+untracked）：`17392` 行
- 其中核心包：`10122` 行
- 多尺度模块：`2383` 行
- 脚本：`4181` 行
- 测试：`1720` 行

说明：
- 当前已显著扩展，但仍未达到 3~5 万目标；
- 后续将优先扩展“高价值代码”（多保真求解器、反向设计闭环、主动学习调度器）而非无效堆行数。
