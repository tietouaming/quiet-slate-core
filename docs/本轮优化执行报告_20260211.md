# 本轮优化执行报告（2026-02-11）

## 1. 目标与完成情况

本轮按你的评审意见完成了以下关键优化，并保持现有功能可用：

1. surrogate 门控从“纯启发式阈值”升级为“三重物理门控”
2. 新增离散自由能记账与能量上升限制
3. 新增 PDE 残差门控（`phi/c/eta/mechanics`）
4. 新增不确定性门控接口（输入微扰多样本估计）
5. 新增自适应 rollout 频率控制（可动态增减 surrogate 触发间隔）
6. surrogate 关闭力学校正时补充一致应力重建，避免诊断量滞后
7. 训练损失与主求解器一致化：`h(phi)*c` 守恒 + 孪晶本征应变进入力学残差
8. 增加门控专项测试并通过

## 2. 代码级改动

### 2.1 `mg_coupled_pf/config.py`

`MLConfig` 新增参数：

- PDE 残差门控：
  - `enable_pde_residual_gate`
  - `pde_residual_phi_abs_max`
  - `pde_residual_eta_abs_max`
  - `pde_residual_c_abs_max`
  - `pde_residual_mech_abs_max`
- 能量门控：
  - `enable_energy_gate`
  - `energy_abs_increase_max`
  - `energy_rel_increase_max`
- 不确定性门控：
  - `enable_uncertainty_gate`
  - `uncertainty_samples`
  - `uncertainty_jitter_std`
  - `uncertainty_gate`
- 自适应 rollout：
  - `adaptive_rollout`
  - `rollout_min_every`
  - `rollout_max_every`
  - `rollout_success_streak_to_increase`
  - `rollout_reject_streak_to_decrease`

### 2.2 `mg_coupled_pf/simulator.py`

新增/增强核心能力：

- 新增状态物理量计算：
  - `_estimate_state_mechanics()`：基于当前位移场快速重建应力/应变
  - `_compute_mechanics_residual()`：`div(sigma)` 残差
  - `_compute_free_energy()`：离散总自由能密度（化学、相场、孪晶、梯度、弹性）
  - `_compute_pde_residuals()`：`phi/c/eta/mechanics` 残差
  - `_estimate_surrogate_uncertainty()`：输入微扰多样本不确定性估计
- surrogate gate 改造：
  - 保留原有阈值门控（均值/单步增量）
  - 叠加 PDE 残差门控
  - 叠加能量门控
  - 叠加不确定性门控（可开关）
- rollout 策略改造：
  - `_current_rollout_every` 动态调整
  - 连续接受后放宽（更少锚定）
  - 连续拒绝后收紧（更保守）
- 进度输出增强：
  - 增加 `F, Rphi, Rc, Reta, Rmech, roll`
- 历史输出增强：
  - `history.csv` 增加 `free_energy/pde_res_*/rollout_every`

### 2.3 `scripts/train_surrogate.py`

训练物理损失一致化：

- 质量约束从 `mean(c)` 升级为 `mean(h(phi)*c)`
- 力学残差加入孪晶本征应变项（与主求解器方向定义一致）
- 保留液相惩罚，继续约束液相中 `eta/epspeq`

### 2.4 `configs/notch_case.yaml`

加入上述新门控参数默认值，便于直接复现实验。

### 2.5 `tests/test_numerical_stability.py`

新增测试：

- `test_surrogate_gate_rejects_by_pde_residual`
- `test_surrogate_gate_rejects_by_energy_increase`

## 3. 测试与验证

### 3.1 语法检查

执行：

```powershell
python -m py_compile mg_coupled_pf/simulator.py
python -m py_compile scripts/train_surrogate.py
python -m py_compile mg_coupled_pf/config.py
```

结果：全部通过。

### 3.2 单元测试

执行：

```powershell
python -m pytest -q tests
```

结果：`14 passed`。

说明：

- 先前环境中 `numpy` 损坏（`np.ndarray` 丢失）导致 torch 导入失败，已通过重新安装修复。
- 全量 `pytest` 会扫到历史备份目录；本次按 `tests/` 主目录执行，避免重复收集旧副本。

### 3.3 小规模算例验证

1) 正式对照脚本烟测（0.01s 物理时长）：

```powershell
python scripts/run_formal_comparison.py --total-time-s 0.01 --dt-s 1e-4 --save-interval-s 0.01 --progress-every 25 --case-tag pde_gate_smoke --report-json artifacts/reports/pde_gate_smoke.json --report-md artifacts/reports/pde_gate_smoke.md
```

输出：

- `artifacts/reports/pde_gate_smoke.json`
- `artifacts/reports/pde_gate_smoke.md`

2) 主求解器短程运行（禁用 ML）：

```powershell
python scripts/run_notched_case.py --config configs/notch_case.yaml --total-time-s 0.001 --dt-s 1e-4 --save-interval-s 0.001 --progress --progress-every 5 --disable-ml --no-render-intermediate-fields --no-render-final-clouds --no-render-grid-figure
```

结果：

- 运行稳定
- 进度中已输出 `F/Rphi/Rc/Reta/Rmech/roll`

## 4. 与评审意见的对应关系

已完成（本轮落地）：

1. 残差 gate：完成
2. 能量 gate：完成
3. 不确定性 gate：完成（默认可关闭）
4. 训练物理项一致化：完成第一版
5. 自适应 rollout + 回退：完成

未在本轮一次性替换的高成本项（后续可继续）：

1. 力学求解从当前 Krylov 路线进一步升级到 AMG/学习预条件协同
2. 相场时间推进升级到 SAV/IEQ 严格能量稳定离散
3. surrogate 端到端 PINO 多分辨率残差训练

## 5. 建议下一步

1. 基于当前门控框架，先做“仅力学 warmstart surrogate”专项训练与对照（风险最低）
2. 将 `enable_uncertainty_gate=true` 打开做短程 A/B，校准 `uncertainty_gate`
3. 对 5s、50s、500s 三个物理时长做误差增长曲线，确认长期漂移上界

## 6. 按顺序继续优化：力学加载模式显式化（本轮新增）

### 6.1 改造内容

1. `MechanicsConfig` 新增：
   - `loading_mode`（`eigenstrain` / `dirichlet_x`）
   - `dirichlet_right_displacement_um`
2. `mechanics.py`：
   - 位移场约束与线性系统向量约束拆分：
     - `_apply_displacement_constraints()`
     - `_apply_vector_constraints()`
   - `dirichlet_x` 模式下：
     - 左边界 `ux=0`
     - 右边界 `ux=u_right`
     - 应变分解中关闭宏观外加应变项重复叠加
3. `train_surrogate.py`：
   - 力学损失中的外加应变项按加载模式一致化

### 6.2 新增测试

- `tests/test_numerical_stability.py::test_mechanics_dirichlet_x_boundary_enforced`
- 验证右边界位移约束误差 < `1e-6`

### 6.3 运行与结果

- 单元测试：`python -m pytest -q tests` -> `15 passed`
- 加载模式基准：
  - 脚本：`scripts/benchmark_loading_modes.py`
  - 报告：`artifacts/reports/loading_mode_benchmark_20260211.json`
  - 边界误差：`3.576e-08 um`
