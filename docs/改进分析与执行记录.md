# 程序改进分析与执行记录

## 一、改进目标

在不破坏现有功能的前提下，逐条提升可用性与性能，重点是：

1. 环境可复现，支持 CPU/GPU 一键切换。  
2. 训练/推理脚本可显式控制设备与性能开关。  
3. GPU 上尽量利用性能（混合精度、warmup、同步计时、channels-last）。  
4. 保持数值稳定，避免因激进加速导致结果崩溃。  

## 二、已实施改进（逐条）

### 1) 一键环境脚本增强（已完成）

- 文件：`scripts/setup_env.ps1`
- 改进：
  - 新增 `-TorchVariant auto|cpu|cu126|cu124|cu121`
  - 自动检测 `nvidia-smi`，优先安装 CUDA 版 PyTorch
  - 自动回退策略（`auto` 模式下多版本尝试）
  - 环境摘要中输出 `torch_cuda`、`cuda_available`、`cuda_device_count`

### 2) 仿真脚本增加性能控制参数（已完成）

- 文件：`scripts/run_notched_case.py`
- 改进：
  - 新增 `--device`
  - 新增 `--mixed-precision`
  - 新增 `--disable-torch-compile`
  - 新增 `--disable-inference-mode`
  - 新增 `--no-clean-output`

### 3) 基准脚本改进为 GPU 友好计时（已完成）

- 文件：`scripts/benchmark_solver.py`
- 改进：
  - 新增 `--warmup-steps`
  - 新增 `--device` / `--mixed-precision` / `--disable-torch-compile`
  - 计时前后增加 CUDA `synchronize()`，避免异步误差

### 4) 训练脚本 GPU 优化（已完成）

- 文件：`scripts/train_surrogate.py`
- 改进：
  - 新增 `--device` / `--mixed-precision` / `--channels-last` / `--disable-torch-compile`
  - CUDA 下支持 channels-last 内存格式
  - 保留 AMP + GradScaler 路径

### 5) surrogate 推理兼容性增强（已完成）

- 文件：`mg_coupled_pf/ml/surrogate.py`
- 改进：
  - 增加 channels-last 推理路径
  - `torch.compile` 仅在可用后端下启用
  - 自动规避 Windows + CUDA Triton 缺失导致的运行时崩溃

### 6) 物理步进混合精度支持（已完成）

- 文件：`mg_coupled_pf/simulator.py`
- 改进：
  - CUDA 下按 `numerics.mixed_precision` 开关启用 autocast
  - CPU 路径保持原行为

### 7) 自动检查脚本增加设备透传（已完成）

- 文件：`scripts/run_all_checks.py`
- 改进：
  - 新增 `--device` / `--mixed-precision` / `--disable-torch-compile`
  - 统一透传到运行、训练、基准脚本

### 8) GPU 配置模板（已完成）

- 文件：`configs/notch_case_gpu.yaml`
- 作用：
  - 提供可直接运行的 GPU 配置模板

### 9) 完整中文命令手册（已完成）

- 文件：`docs/中文操作手册.md`

### 10) 计算过程可视化进度与在线损失（已完成）

- 文件：`scripts/run_notched_case.py`、`scripts/run_formal_comparison.py`
- 改进：
  - 支持进度条输出（百分比、步号、关键状态）
  - 正式对照算例支持在线损失输出：
    - `loss_solid`
    - `loss_eta`
    - `loss_sigma_h`
    - `loss_epspeq`
    - `loss_phi_mae`
    - `loss_c_mae`

### 11) 结束后云图自动导出（已完成）

- 文件：`mg_coupled_pf/io_utils.py`、`mg_coupled_pf/simulator.py`
- 改进：
  - 自动导出 `von_mises / eta / cMg / phi` 四张云图
  - 自动导出四图拼图 `final_clouds_2x2.png`

### 12) 误差进一步收敛（已完成）

- 文件：`mg_coupled_pf/config.py`、`configs/notch_case.yaml`、`mg_coupled_pf/simulator.py`
- 改进：
  - 收紧 surrogate 均值增量门控
  - surrogate 步后增加力学校正，抑制长期漂移

### 13) 理论一致性修正（cMg / yeta）已完成

- 文件：`mg_coupled_pf/geometry.py`、`mg_coupled_pf/simulator.py`、`mg_coupled_pf/config.py`
- 修正：
  - `cMg` 采用归一化定义：液相0、固相1
  - 初始场设置为液相 `cMg=0`、固相 `cMg=1`（界面平滑）
  - `yeta` 仅在固相存在：演化后乘 `h(phi)` 强制液相为0

### 14) 精细网格配置与效率优化（已完成）

- 文件：`configs/notch_case_highres.yaml`
- 改进：
  - 提供 512x320 细网格配置
  - 默认关闭中间场图渲染以减少I/O开销
  - 保留最终云图输出用于复核

### 15) 云图网格叠加与物理时间标注（已完成）

- 文件：`mg_coupled_pf/io_utils.py`、`mg_coupled_pf/simulator.py`、`scripts/run_formal_comparison.py`
- 改进：
  - 所有最终云图增加坐标网格叠加（主/次网格）
  - 云图标题统一标注物理时间 `t = ... s`
  - 2x2 拼图增加统一物理时间标题
  - 中间场图输出同样支持网格与时间标注
  - 后续在第16项按新要求调整为“网格图与云图分离输出”

### 16) 网格与云图分离输出 + 50万网格与缺口加密（已完成）

- 文件：`mg_coupled_pf/geometry.py`、`mg_coupled_pf/operators.py`、`mg_coupled_pf/mechanics.py`、`mg_coupled_pf/simulator.py`、`mg_coupled_pf/io_utils.py`、`configs/half_half_highres.yaml`
- 改进：
  - 高分辨率算例网格提升到 `1024 x 512 = 524,288`（>= 50w）
  - 引入缺口附近静态非均匀网格加密（x/y 双向密度函数映射）
  - 导数算子支持非均匀坐标（`grad/div/laplacian`）
  - 网格图单独输出到 `grid/` 目录，云图保持在 `final_clouds/` 目录
  - 云图不再叠加网格线，仅保留物理时间标注
  - 云图配色改为高值红、低值蓝

### 17) 界面可视化增强（已完成）

- 文件：`mg_coupled_pf/io_utils.py`、`mg_coupled_pf/simulator.py`、`configs/half_half_highres.yaml`
- 改进：
  - 云图绘制切换为支持非均匀网格的坐标映射（避免等宽像素失真）
  - 最终云图新增 SVG 矢量输出
  - 新增缺口尖端局部放大云图输出目录 `final_clouds_tip_zoom/`
  - 半空间界面宽度参数调整为 `interface_width_um = 0.97`（目标 1-2 um）
  - 尖端局部放大窗口固定为 `12 um × 9 um`

### 18) cMg 规律异常定位与修复（已完成）

- 问题定位：
  - 在 50 万级非均匀加密网格下，`dt` 超过显式扩散稳定上限，导致 `cMg` 更新出现数值饱和倾向（后续被 `clip` 到 `[0,1]`，表现为分布异常）。
- 修复文件：`mg_coupled_pf/simulator.py`、`mg_coupled_pf/config.py`、`scripts/run_notched_case.py`
- 修复内容：
  - 新增扩散稳定上限估计 `diffusion_dt_limit_s`
  - 扩散方程改为**自适应子步进**（`diffusion_auto_substeps`）
  - surrogate 相关 `c` 门控与裁剪改为使用 `cMg_min/cMg_max`，移除旧的 `1.5` 硬编码
  - 运行结果 JSON 输出 `diffusion_dt_limit_s` 便于核查
- 修复后验证：
  - `5s` 试算下液相 `cMg` 不再出现大面积接近 `1` 的非物理饱和，液相均值约 `7.1e-3`

## 三、小规模试算记录（本轮）

### 1) GPU 环境验证

- 命令：`scripts/setup_env.ps1 -VenvPath .venv_gpu -TorchVariant auto -Recreate`
- 结果：
  - `torch 2.10.0+cu126`
  - `cuda_available = True`
  - `cuda_device_count = 1`

### 2) GPU 小规模基准（40步）

- 命令：`scripts/benchmark_solver.py --config configs/notch_case.yaml --device cuda --steps 40 --warmup-steps 10`
- 结果：
  - 纯物理：`~9.96 step/s`
  - ML启用：`~20.42 step/s`
  - 加速比：`~2.05x`

### 3) GPU 全流程小规模检查

- 命令：
  - `scripts/run_all_checks.py --config configs/notch_case.yaml --device cuda --physics-steps 40 --ml-steps 40 --bench-steps 40 --train-epochs 3 --train-batch-size 8 --max-solid-drift 0.1 --min-speedup 1.05`
- 结果：
  - `passed = true`
  - `speedup ~1.80x`
  - `solid_fraction_abs_diff ~0.0039`

## 四、下一步可继续优化（未改动核心理论前提下）

1. 将力学子步从显式松弛改为更高效的线性求解器（如多重网格/FFT 预条件）  
2. 对腐蚀-扩散部分引入半隐式时间离散，提高大步长稳定性  
3. surrogate 从单步残差升级为多步一致性训练（teacher forcing + rollout loss）  
4. 输出保存异步化（I/O线程）以减少主求解阻塞  
5. 针对 RTX 30 系列补充更细粒度 profile（Nsight）并做 kernel 级优化  

## 五、本轮新增：在准确性约束下实现 10x+ 提速（已完成）

### 19) 扩散积分器升级为 STS（已完成）

- 文件：`mg_coupled_pf/config.py`、`mg_coupled_pf/simulator.py`
- 改进：
  - 新增 `numerics.diffusion_integrator`，支持 `subcycled_euler / sts`
  - 新增 STS 参数：
    - `diffusion_sts_nu`
    - `diffusion_sts_max_stages`
  - 在 `simulator` 中加入 stage 计划缓存，避免重复构造
  - 扩散更新重构为通用 `rhs` + stage 推进
- 效果：
  - 在高分辨率工况下，`dt=0.005` 时扩散 stage 数从保守设置下的 239 下降到 17（`nu=5e-4`）

### 20) 力学求解器自适应提前收敛（已完成）

- 文件：`mg_coupled_pf/config.py`、`mg_coupled_pf/mechanics.py`
- 改进：
  - 新增参数：
    - `mechanics_adaptive_substeps`
    - `mechanics_min_substeps`
    - `mechanics_residual_tol`
    - `mechanics_residual_rel_tol`
  - 在准静态力学迭代中依据残差提前停止，减少无效迭代

### 21) surrogate 物理约束增强（已完成）

- 文件：`mg_coupled_pf/simulator.py`、`mg_coupled_pf/ml/surrogate.py`
- 改进：
  - surrogate 有效性检查新增液相约束：液相 `eta/epspeq` 残留超阈值时拒绝
  - surrogate 输出后直接执行固相掩膜：`eta, epspeq` 仅保留在固相

### 22) 训练脚本大数据流式训练（已完成）

- 文件：`scripts/train_surrogate.py`
- 改进：
  - 支持 `--streaming`、`--num-workers`、`--max-pairs`
  - 快照对按需读取，降低内存峰值，便于高分辨率数据训练

### 23) 10x 对照试算结果（0.5 s 物理时长）

- 报告：`artifacts/reports/fast_physics_vs_baseline_0p5s_nu5e4.json`
- 对照：
  - 基线：`dt=1e-3`，500步，`configs/half_half_highres_ml_pure.yaml`（ML关闭）
  - 加速：`dt=5e-3`，100步，`configs/half_half_highres_fast_physics.yaml`（ML关闭）
- 结果：
  - 基线耗时：`88.93 s`
  - 加速耗时：`6.07 s`
  - 加速比：`14.64x`
  - 终态误差：
    - `phi MAE = 4.60e-09`
    - `cMg MAE = 9.28e-04`
    - `eta MAE = 0`
    - `epspeq MAE = 6.73e-07`
    - `solid_fraction abs diff = 0`

### 24) 5 s 长时稳定性试算（已完成）

- 运行目录：`artifacts/sim_notch/mg_half_half_tri_notch_highres_fast_physics`
- 结果摘要：
  - `dt=0.005 s`，`total_time=5 s`，`n_steps=1000`
  - 进度日志全程稳定，无 NaN/发散
  - 液相 `eta=0`，`cMg` 保持在 `[0,1]`，液相均值约 `2.40e-3`

### 25) ML 分支复测结论（本轮不作为默认交付）

- 报告：
  - `artifacts/reports/fastml_0p5s_report.json`
  - `artifacts/reports/fastml_retrained_0p5s_report.json`
- 结论：
  - 当前 full-state surrogate 在该高分辨率工况下仍会引入应力漂移风险
  - 相对“加速物理方案”额外提速不足且精度风险高
  - 默认交付采用 `fast_physics` 路线（准确性优先）

### 26) 架构继续优化：可复用的步长校准器（已完成）

- 文件：`scripts/calibrate_fast_dt.py`
- 作用：
  - 自动运行“基线 dt”与多个候选快 dt 的短程对照
  - 按 `c/phi/epspeq` MAE 阈值筛选可接受候选
  - 自动给出“满足精度约束下速度最快”的推荐 `dt`
- 本轮结果：
  - 报告：`artifacts/reports/dt_calibration_report.json`
  - 推荐：`dt=0.005 s`
  - 加速比约 `14.64x`

### 27) 架构继续优化：求解器统计可观测性（已完成）

- 文件：`mg_coupled_pf/simulator.py`、`scripts/run_notched_case.py`、`scripts/run_formal_comparison.py`
- 改进：
  - 新增 `solver_stats` 统计项：
    - `mech_predict_solve`
    - `mech_correct_solve`
    - `mech_correct_skipped_elastic`
  - 运行 JSON/报告中可直接查看优化触发率，便于后续定量迭代

### 28) 晶体塑性弹性捷径（可选开关，已完成）

- 文件：`mg_coupled_pf/config.py`、`mg_coupled_pf/crystal_plasticity.py`
- 改进：
  - 新增 `crystal_plasticity.elastic_shortcut`（默认 `false`）
  - 在过应力模型下若全域严格弹性，可跳过塑性增量与硬化更新（方程等价）
- 说明：
  - 默认关闭，不影响现有高精度主流程
  - 在弹性主导工况可开启进一步降耗

### 29) 前沿模型接入：FNO2D surrogate（已完成）

- 文件：`mg_coupled_pf/ml/surrogate.py`、`scripts/train_surrogate.py`、`mg_coupled_pf/config.py`、`mg_coupled_pf/simulator.py`
- 改进：
  - surrogate 支持 `model_arch` 多架构切换（`tiny_unet` / `fno2d`）
  - 保存模型时写入 `meta.model_arch + arch_kwargs`，加载时自动识别
  - 训练脚本新增参数：`--model-arch`、`--fno-width`、`--fno-modes-x/y`、`--fno-depth`
  - 配置新增 FNO 超参数字段

### 30) surrogate 推理架构基准脚本（已完成）

- 文件：`scripts/benchmark_surrogate_models.py`
- 作用：
  - 在指定分辨率、设备和超参数下对比 TinyUNet/FNO2D 的单步推理延迟
- 本轮实测（`512x1024`, RTX3060）：
  - 结果文件：`artifacts/reports/surrogate_arch_benchmark_4models.json`
  - TinyUNet（hidden=32）：约 `21.91 ms/step`
  - FNO2D（width=16,modes=12x8,depth=3）：约 `23.39 ms/step`
- 结论：
  - FNO2D 已接入，但当前硬件与超参数下尚未超过 TinyUNet 单步推理速度；
  - 后续价值在于潜在更高接受率/更低锚定频率。

### 31) FNO 训练稳定性兼容（已完成）

- 文件：`scripts/train_surrogate.py`、`mg_coupled_pf/ml/surrogate.py`
- 改进：
  - `fno2d` 训练时自动关闭 AMP（避免 CUDA `ComplexHalf` FFT 限制）
  - `fno2d` 推理时在 surrogate 内部禁用 autocast，保证频域算子稳定
- 验证：
  - 已完成 FNO 短程训练烟测与推理烟测（`run_notched_case` 可正常运行）

### 32) 新增前沿模型：AFNO2D 与 DW-UNet（已完成）

- 文件：`mg_coupled_pf/ml/surrogate.py`、`mg_coupled_pf/config.py`、`scripts/train_surrogate.py`
- 改进：
  - 新增 surrogate 架构：
    - `afno2d`（前沿频域算子，轻量化实现）
    - `dw_unet`（深度可分离卷积）
  - 训练/加载/推理链路全部支持新架构
  - 模型元信息自动保存与加载（避免架构错配）

### 33) 新增四模型统一基准（已完成）

- 文件：`scripts/benchmark_surrogate_models.py`
- 能力：
  - 支持一次性对比 `tiny_unet,dw_unet,fno2d,afno2d`
  - 输出最快架构与相对 tiny 的速度比
- 报告：
  - `artifacts/reports/surrogate_arch_benchmark_4models.json`
- 本轮实测（512x1024, RTX3060）：
  - `afno2d`（width=12,modes=8x6,depth=2）达到最快，约为 tiny 的 `1.60x` 推理速度

### 34) 长时精度门槛（<=2%）达成与配置收敛（已完成）

- 目标：在 `5.0 s` 物理时间内将最终误差控制在 `<=2%`，同时保持 ML 加速。
- 过程：
  - 先验证旧配置 `surrogate_delta_scale=0.02`：5s 出现长期漂移（`phi` 超 2%）。
  - 继续做参数收敛：将代理增量缩放降低到 `0.005`，漂移明显下降但 `phi` 仍约 2.5%。
  - 最终收敛到 `surrogate_delta_scale=0.003`（`anchor_physics_every=20`、`surrogate_update_mechanics_fields=false`）。
- 最终报告：`artifacts/reports/afno_scale0003_5s_report.json`
- 关键结果（5s）：
  - `final_field_metrics.phi.mae = 0.01594`（1.594%）
  - `final_field_metrics.c.mae = 0.01144`（1.144%）
  - `final_field_metrics.eta.mae = 0.00384`（0.384%）
  - `final_solid_fraction_abs_diff = 0.00224`（0.224%）
  - `speedup_physics_over_ml = 3.03x`
- 配置落地：
  - 已将 `configs/half_half_highres_ml_afno_scaled.yaml` 的 `surrogate_delta_scale` 更新为 `0.003`。
- 说明：
  - 使用项目虚拟环境运行（`.venv_gpu`）；系统 `D:\Anaconda\python.exe` 的 `numpy` 环境存在异常，不用于正式对照。

## 六、本轮补充：三重门控与训练一致化（2026-02-11）

### 35) surrogate 三重门控（已完成）

- 文件：`mg_coupled_pf/config.py`、`mg_coupled_pf/simulator.py`
- 新增：PDE 残差门控、能量门控、不确定性门控
- 结果：surrogate 接受判据从启发式阈值升级为物理约束优先

### 36) 自适应 rollout（已完成）

- 文件：`mg_coupled_pf/simulator.py`
- 新增：根据接受/拒绝连续统计动态调整 `rollout_every`
- 结果：在稳定区间自动提高加速倾向，失稳区间自动回收到保守策略

### 37) 训练物理损失一致化（已完成）

- 文件：`scripts/train_surrogate.py`
- 新增：`h(phi)*c` 守恒项、孪晶本征应变进入力学残差

### 38) 测试与烟测（已完成）

- 语法检查：`py_compile` 通过
- 测试：`python -m pytest -q tests`，`14 passed`
- 结果报告：`docs/本轮优化执行报告_20260211.md`

### 39) 力学加载模式显式化（已完成）

- 文件：`mg_coupled_pf/config.py`、`mg_coupled_pf/mechanics.py`、`scripts/train_surrogate.py`
- 改进：
  - 新增 `mechanics.loading_mode`：`eigenstrain / dirichlet_x`
  - 新增 `mechanics.dirichlet_right_displacement_um`
  - 位移场约束与线性系统向量约束解耦（避免 Krylov 残差向量误施加位移常值）
  - 训练损失中的外加应变项按加载模式一致化

### 40) 加载模式专项测试（已完成）

- 测试新增：`test_mechanics_dirichlet_x_boundary_enforced`
- 结果：`python -m pytest -q tests` -> `15 passed`

### 41) 加载模式基准（已完成）

- 脚本：`scripts/benchmark_loading_modes.py`
- 报告：`artifacts/reports/loading_mode_benchmark_20260211.json`
- 关键结论：
  - `dirichlet_x` 右边界位移误差 `3.58e-08 um`（边界约束生效）
