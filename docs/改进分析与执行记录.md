# 程序改进分析与执行记录

## 2026-02-14 专业化扩展（配置审计与质量门控，已完成）

为提升“专业度 + 准确性 + 可维护性”，新增配置审计层并接入主运行链路。

1. 新增配置审计模块  
- 新文件：`mg_coupled_pf/validation.py`  
- 关键能力：  
  - 网格/界面厚度分辨率审计  
  - 扩散步长稳定性审计  
  - 滑移/孪晶系统正交归一审计  
  - CP/力学取向一致性审计  
  - ML 门控与能量项一致性审计  
  - 结构化报告输出（JSON）

2. 主运行脚本接入审计  
- 文件：`scripts/run_notched_case.py`  
- 新参数：  
  - `--audit-config` / `--no-audit-config`  
  - `--strict-audit`  
  - `--audit-output`  
- 行为：默认仿真前执行审计，strict 模式下有 error 直接阻断运行。

3. 新增独立审计脚本  
- 新文件：`scripts/audit_config.py`  
- 用法：可独立在批量任务前快速做配置体检。

4. 自动化检查链路增强  
- 文件：`scripts/run_all_checks.py`  
- 变更：在单测和试算前，新增 `scripts/audit_config.py --strict` 步骤。

5. 测试补充  
- 新文件：`tests/test_config_validation.py`  
- 覆盖：默认配置通过、非法口径拦截、界面分辨率不足拦截、取向不一致告警、系统非正交拦截、报告写出。

6. 配套文档更新  
- 更新：`docs/中文操作手册.md`（新增审计命令与 strict 运行方式）  
- 更新：`docs/库与用法详解.md`（新增审计模块说明）  
- 更新：`pyproject.toml`（依赖信息更完整）

7. 本轮验证结果  
- `python -m pytest -q` -> `56 passed`  
- `python scripts/audit_config.py --config configs/notch_case.yaml --strict` -> `PASS`  
- `python scripts/run_notched_case.py ... --strict-audit` -> 运行通过并输出审计摘要

## 2026-02-14 物理一致性与状态闭合大改（已完成）

本轮针对“符号定义漂移/平面应力不自洽/塑性历史含义混淆”做了 P0 级修正，并完成全量回归。

1. `phi` 界面厚度口径显式化（避免参数偷换）  
- 文件：`mg_coupled_pf/config.py`、`mg_coupled_pf/simulator.py`  
- 新增：`corrosion.interface_thickness_definition`  
- 说明：默认 `tanh_half_width` 口径下，采用  
  - `omega = 3*gamma/(8*ell)`  
  - `kappa = 3*gamma*ell`  
  历史口径可通过 `legacy_energy_equiv` 保持兼容。  

2. 各向异性平面应力改为严格消元（不再“伪平面应力”）  
- 文件：`mg_coupled_pf/mechanics.py`  
- 新增：`_extract_plane_stress_coeffs`，按 `sigma_zz=0` 做 Schur 消元得到 2D 等效刚度。  
- 结果：`plane_strain=False` 时不再沿用平面应变系数后再强行置零。  

3. `epspeq` 改为 total 路径（滑移 + 孪晶转变速率）  
- 文件：`mg_coupled_pf/simulator.py`、`mg_coupled_pf/config.py`  
- 新增状态：`epspeq_slip/epspeq_twin/epspeq_dot_slip/epspeq_dot_twin`。  
- 新增参数：`corrosion.epspeq_twin_weight`。  
- 逻辑：总速率 `epspeq_dot = epspeq_dot_slip + w_twin*epspeq_dot_twin`，并积分到 `epspeq`。  

4. 腐蚀应力驱动默认使用固相本构应力  
- 文件：`mg_coupled_pf/mechanics.py`、`mg_coupled_pf/simulator.py`、`mg_coupled_pf/config.py`  
- 新增输出：`sigma_*_solid`, `sigma_h_solid`（未乘 `h(phi)` 的固相应力）。  
- 新增参数：`corrosion.use_solid_sigma_for_corrosion`（默认 `true`）。  

5. CP 硬化从单变量升级为母晶/孪晶双变量  
- 文件：`mg_coupled_pf/crystal_plasticity.py`、`mg_coupled_pf/simulator.py`  
- 新增内部变量：`g_parent/g_twin`、`gamma_accum_parent/gamma_accum_twin`。  
- 机制：母晶与孪晶相分别更新硬化，再按 `f_twin=h(eta)` 混合输出兼容字段 `g/gamma_accum`。  

6. 默认 HCP 滑移系去除手填笛卡尔向量  
- 文件：`mg_coupled_pf/config.py`  
- 修正：`default_slip_systems_hcp_3d()` 的 pyramidal 系统改为四指数输入（`direction_mb/plane_mb`），统一走 `c/a` 感知转换。  

7. 新增/更新测试  
- 文件：`tests/test_numerical_stability.py`  
- 新增覆盖：  
  - `omega/kappa` 新口径公式；  
  - 腐蚀 mobility 使用 `sigma_h_solid`；  
  - `epspeq_dot` 包含孪晶速率；  
  - 各向异性平面应力下 `sigma_zz=0`。  

8. 测试与试算结果  
- 全量测试：`python -m pytest -q` -> `50 passed`。  
- 快速试算：`python scripts/run_notched_case.py --config configs/notch_case.yaml --disable-ml --total-time-s 0.001 ...` 成功完成。  

## 2026-02-13 新一轮关键修正（已完成）

本轮针对“符号偷换/状态闭合/ML量纲混合”问题做了核心修正，并完成回归测试。

1. 机械耦合能量一致性修正  
- 文件：`mg_coupled_pf/simulator.py`  
- 修正：`_mech_phi_coupling_energy_density` 从 `sigma^2/mu` 改为与自由能一致的 `0.5*sigma:epsilon`。  
- 目的：消除“方程驱动与能量门控使用不同机械量”的不一致。

2. 腐蚀机械放大项改为速率驱动  
- 文件：`mg_coupled_pf/simulator.py`、`mg_coupled_pf/config.py`  
- 修正：`_corrosion_mobility` 默认使用 `epspeq_dot`（新增配置 `use_epspeq_rate_for_mobility`、`epspeq_dot_ref_s_inv`、`k_epsdot`），不再默认用累计 `epspeq`。  
- 同步：物理步、surrogate-accept、非力学更新步都显式维护 `state["epspeq_dot"]`。

3. surrogate 接受后 CP 状态闭合增强  
- 文件：`mg_coupled_pf/simulator.py`  
- 修正：surrogate 接受后若走 CP 同步路径，除 `g/gamma_accum` 外也同步 `epspeq_dot`；若不允许 surrogate 更新塑性场，则将 `epspeq_dot` 清零，避免伪速率驱动。

4. ML 通道尺度归一化（训练与推理统一）  
- 新增文件：`mg_coupled_pf/ml/scaling.py`  
- 修改文件：`mg_coupled_pf/ml/surrogate.py`、`mg_coupled_pf/ml/mech_warmstart.py`、`scripts/train_surrogate.py`、`scripts/train_mechanics_warmstart.py`、`mg_coupled_pf/simulator.py`  
- 说明：  
  - 按配置自动生成通道尺度（位移/塑性应变量归一化）；  
  - surrogate/warmstart 保存 checkpoint 时写入 `field_scales` 元信息；  
  - 加载模型时自动恢复尺度，训练和推理口径一致。  

5. 参数语义澄清  
- 文件：`mg_coupled_pf/config.py`  
- 修正：补充 `TwinningConfig.L_eta` 与 `gamma_twin` 的单位/物理含义注释，避免“动力学系数与几何剪切”混淆。

6. 回归测试结果  
- 命令：`python -m pytest -q`  
- 结果：`44 passed`（无失败）。

## 2026-02-14 晶体学一致性大改（已完成）

1. 孪晶系从“固定实验室角度”改为“晶体学系 + 取向旋转”  
- 新增：`mg_coupled_pf/crystallography.py`  
- 修改：`mg_coupled_pf/mechanics.py`、`mg_coupled_pf/simulator.py`、`scripts/train_surrogate.py`  
- 结果：孪晶系 `(s,n)` 会随 `crystal_orientation_euler_deg` 变化，不再与取向设置冲突。

2. slip/twin 系统一入口校验与正交化  
- 修改：`mg_coupled_pf/config.py`  
- 新增配置：`twinning.twin_systems_file`、`twinning.twin_variant_index`、`twinning.twin_hcp_c_over_a`、`crystal_plasticity.hcp_c_over_a`  
- 结果：加载后统一得到归一且正交的 `s_crystal/n_crystal`，避免 `s·n≠0` 伪应变。

3. 默认系统文件切换为 3D 晶体学定义  
- 修改：`configs/notch_case.yaml`  
- 新增：`configs/twin_systems_hcp_3d.json`  
- 更新：`configs/slip_systems_hcp_3d.json`（四指数定义 + 自动转换）。

4. 塑性等效应变率计算改为不可压形式  
- 修改：`mg_coupled_pf/crystal_plasticity.py`  
- 结果：`epspeq_dot` 基于 `epsp_dot_zz = -(epsp_dot_xx + epsp_dot_yy)` 计算，减少 trace 漂移。

5. 新增一致性测试  
- 新增：`tests/test_crystallography_consistency.py`  
- 覆盖：  
  - 载入后 slip/twin 系统正交归一；  
  - 孪晶系随晶体取向旋转。

6. 回归测试结果  
- 命令：`python -m pytest -q`  
- 结果：`46 passed`（无失败）。

## 一、改进目标

在不破坏现有功能的前提下，逐条提升可用性与性能，重点是：

1. 环境可复现，支持 CPU/GPU 一键切换。  
2. 训练/推理脚本可显式控制设备与性能开关。  
3. GPU 上尽量利用性能（混合精度、warmup、同步计时、channels-last）。  
4. 保持数值稳定，避免因激进加速导致结果崩溃。  

## 二、已实施改进（逐条）

### 1) 一键环境脚本增强（已完成）

- 文件：`scripts/setup_env.ps1`
- 改进：
  - 新增 `-TorchVariant auto|cpu|cu126|cu124|cu121`
  - 自动检测 `nvidia-smi`，优先安装 CUDA 版 PyTorch
  - 自动回退策略（`auto` 模式下多版本尝试）
  - 环境摘要中输出 `torch_cuda`、`cuda_available`、`cuda_device_count`

### 2) 仿真脚本增加性能控制参数（已完成）

- 文件：`scripts/run_notched_case.py`
- 改进：
  - 新增 `--device`
  - 新增 `--mixed-precision`
  - 新增 `--disable-torch-compile`
  - 新增 `--disable-inference-mode`
  - 新增 `--no-clean-output`

### 3) 基准脚本改进为 GPU 友好计时（已完成）

- 文件：`scripts/benchmark_solver.py`
- 改进：
  - 新增 `--warmup-steps`
  - 新增 `--device` / `--mixed-precision` / `--disable-torch-compile`
  - 计时前后增加 CUDA `synchronize()`，避免异步误差

### 4) 训练脚本 GPU 优化（已完成）

- 文件：`scripts/train_surrogate.py`
- 改进：
  - 新增 `--device` / `--mixed-precision` / `--channels-last` / `--disable-torch-compile`
  - CUDA 下支持 channels-last 内存格式
  - 保留 AMP + GradScaler 路径

### 5) surrogate 推理兼容性增强（已完成）

- 文件：`mg_coupled_pf/ml/surrogate.py`
- 改进：
  - 增加 channels-last 推理路径
  - `torch.compile` 仅在可用后端下启用
  - 自动规避 Windows + CUDA Triton 缺失导致的运行时崩溃

### 6) 物理步进混合精度支持（已完成）

- 文件：`mg_coupled_pf/simulator.py`
- 改进：
  - CUDA 下按 `numerics.mixed_precision` 开关启用 autocast
  - CPU 路径保持原行为

### 7) 自动检查脚本增加设备透传（已完成）

- 文件：`scripts/run_all_checks.py`
- 改进：
  - 新增 `--device` / `--mixed-precision` / `--disable-torch-compile`
  - 统一透传到运行、训练、基准脚本

### 8) GPU 配置模板（已完成）

- 文件：`configs/notch_case_gpu.yaml`
- 作用：
  - 提供可直接运行的 GPU 配置模板

### 9) 完整中文命令手册（已完成）

- 文件：`docs/中文操作手册.md`

### 10) 计算过程可视化进度与在线损失（已完成）

- 文件：`scripts/run_notched_case.py`、`scripts/run_formal_comparison.py`
- 改进：
  - 支持进度条输出（百分比、步号、关键状态）
  - 正式对照算例支持在线损失输出：
    - `loss_solid`
    - `loss_eta`
    - `loss_sigma_h`
    - `loss_epspeq`
    - `loss_phi_mae`
    - `loss_c_mae`

### 11) 结束后云图自动导出（已完成）

- 文件：`mg_coupled_pf/io_utils.py`、`mg_coupled_pf/simulator.py`
- 改进：
  - 自动导出 `von_mises / eta / cMg / phi` 四张云图
  - 自动导出四图拼图 `final_clouds_2x2.png`

### 12) 误差进一步收敛（已完成）

- 文件：`mg_coupled_pf/config.py`、`configs/notch_case.yaml`、`mg_coupled_pf/simulator.py`
- 改进：
  - 收紧 surrogate 均值增量门控
  - surrogate 步后增加力学校正，抑制长期漂移

### 13) 理论一致性修正（cMg / yeta）已完成

- 文件：`mg_coupled_pf/geometry.py`、`mg_coupled_pf/simulator.py`、`mg_coupled_pf/config.py`
- 修正：
  - `cMg` 采用归一化定义：液相0、固相1
  - 初始场设置为液相 `cMg=0`、固相 `cMg=1`（界面平滑）
  - `yeta` 仅在固相存在：演化后乘 `h(phi)` 强制液相为0

### 14) 精细网格配置与效率优化（已完成）

- 文件：`configs/notch_case_highres.yaml`
- 改进：
  - 提供 512x320 细网格配置
  - 默认关闭中间场图渲染以减少I/O开销
  - 保留最终云图输出用于复核

### 15) 云图网格叠加与物理时间标注（已完成）

- 文件：`mg_coupled_pf/io_utils.py`、`mg_coupled_pf/simulator.py`、`scripts/run_formal_comparison.py`
- 改进：
  - 所有最终云图增加坐标网格叠加（主/次网格）
  - 云图标题统一标注物理时间 `t = ... s`
  - 2x2 拼图增加统一物理时间标题
  - 中间场图输出同样支持网格与时间标注
  - 后续在第16项按新要求调整为“网格图与云图分离输出”

### 16) 网格与云图分离输出 + 50万网格与缺口加密（已完成）

- 文件：`mg_coupled_pf/geometry.py`、`mg_coupled_pf/operators.py`、`mg_coupled_pf/mechanics.py`、`mg_coupled_pf/simulator.py`、`mg_coupled_pf/io_utils.py`、`configs/half_half_highres.yaml`
- 改进：
  - 高分辨率算例网格提升到 `1024 x 512 = 524,288`（>= 50w）
  - 引入缺口附近静态非均匀网格加密（x/y 双向密度函数映射）
  - 导数算子支持非均匀坐标（`grad/div/laplacian`）
  - 网格图单独输出到 `grid/` 目录，云图保持在 `final_clouds/` 目录
  - 云图不再叠加网格线，仅保留物理时间标注
  - 云图配色改为高值红、低值蓝

### 17) 界面可视化增强（已完成）

- 文件：`mg_coupled_pf/io_utils.py`、`mg_coupled_pf/simulator.py`、`configs/half_half_highres.yaml`
- 改进：
  - 云图绘制切换为支持非均匀网格的坐标映射（避免等宽像素失真）
  - 最终云图新增 SVG 矢量输出
  - 新增缺口尖端局部放大云图输出目录 `final_clouds_tip_zoom/`
  - 半空间界面宽度参数调整为 `interface_width_um = 0.97`（目标 1-2 um）
  - 尖端局部放大窗口固定为 `12 um × 9 um`

### 18) cMg 规律异常定位与修复（已完成）

- 问题定位：
  - 在 50 万级非均匀加密网格下，`dt` 超过显式扩散稳定上限，导致 `cMg` 更新出现数值饱和倾向（后续被 `clip` 到 `[0,1]`，表现为分布异常）。
- 修复文件：`mg_coupled_pf/simulator.py`、`mg_coupled_pf/config.py`、`scripts/run_notched_case.py`
- 修复内容：
  - 新增扩散稳定上限估计 `diffusion_dt_limit_s`
  - 扩散方程改为**自适应子步进**（`diffusion_auto_substeps`）
  - surrogate 相关 `c` 门控与裁剪改为使用 `cMg_min/cMg_max`，移除旧的 `1.5` 硬编码
  - 运行结果 JSON 输出 `diffusion_dt_limit_s` 便于核查
- 修复后验证：
  - `5s` 试算下液相 `cMg` 不再出现大面积接近 `1` 的非物理饱和，液相均值约 `7.1e-3`

## 三、小规模试算记录（本轮）

### 1) GPU 环境验证

- 命令：`scripts/setup_env.ps1 -VenvPath .venv_gpu -TorchVariant auto -Recreate`
- 结果：
  - `torch 2.10.0+cu126`
  - `cuda_available = True`
  - `cuda_device_count = 1`

### 2) GPU 小规模基准（40步）

- 命令：`scripts/benchmark_solver.py --config configs/notch_case.yaml --device cuda --steps 40 --warmup-steps 10`

## 四、2026-02-14 大改补充记录（本次提交）

### 1) 3D 晶体学滑移系与取向重构（已完成）

- 文件：
  - `mg_coupled_pf/crystal_plasticity.py`
  - `configs/slip_systems_hcp_3d.json`
  - `mg_coupled_pf/config.py`
- 变更：
  - 支持 `s_crystal/n_crystal` 三维滑移系输入；
  - 支持 Bunge ZXZ 欧拉角取向与轴角孪晶重取向；
  - 维持对旧二维角度格式的兼容读取。

### 2) 力学各向异性 HCP 弹性（可选）落地（已完成）

- 文件：`mg_coupled_pf/mechanics.py`
- 变更：
  - 新增 HCP 四阶刚度构造与取向旋转；
  - 新增 `use_anisotropic_hcp` / `anisotropic_blend_with_twin`；
  - 支持母相/孪晶刚度按 `h(eta)` 混合；
  - Krylov 预条件刚度尺度改为自适应各向异性参考值。

### 3) surrogate 连续固相门控（已完成）

- 文件：`mg_coupled_pf/ml/surrogate.py`
- 变更：
  - 去除 `phi>=0.5` 的硬掩膜；
  - 改为 `h(phi)` 连续权重约束 `eta/epsp/epspeq`。

### 4) 调用链一致性修复（已完成）

- 文件：`mg_coupled_pf/simulator.py`、`mg_coupled_pf/mechanics.py`
- 变更：
  - `constitutive_stress` 新增 `eta` 参数；
  - 所有力学求解与快速估计路径统一传入 `eta`。

### 5) 新增回归测试（已完成）

- 文件：`tests/test_numerical_stability.py`
- 新增用例：
  - `test_mechanics_anisotropic_hcp_stress_is_finite`
  - `test_mechanics_anisotropic_twin_blend_changes_stress`

### 6) 测试结果

- 命令：`python -m pytest -q`
- 结果：`40 passed`

## 五、2026-02-14 二次修正（本轮）

### 1) 孪晶形核激活方向修正（已完成）

- 文件：`mg_coupled_pf/simulator.py`
- 变更：
  - 形核激活由 `relu(abs(tau_tw)-crss)` 改为 `relu(tau_tw-crss)`；
  - 新增 `_twin_nucleation_activation()` 与 `_twin_nucleation_source_amp()`。

### 2) 形核源项命名与兼容（已完成）

- 文件：`mg_coupled_pf/config.py`、`configs/notch_case.yaml`
- 变更：
  - 新增 `twinning.nucleation_source_amp`；
  - 保留 `langevin_nucleation_noise` 兼容读取。

### 3) surrogate 与塑性状态闭合修复（已完成）

- 文件：`mg_coupled_pf/config.py`、`mg_coupled_pf/simulator.py`、`mg_coupled_pf/ml/surrogate.py`
- 变更：
  - 新增 `ml.surrogate_update_plastic_fields`（默认 `false`）；
  - 新增 `ml.surrogate_sync_cp_state_on_accept`（默认 `true`）；
  - `_limit_surrogate_update()` 拆分“位移更新”与“塑性更新”；
  - surrogate accept 后新增 `_sync_cp_state_on_surrogate_accept()`，保证 `cp_state` 同步。

### 4) `h_power` 死参数处理（已完成）

- 文件：`mg_coupled_pf/config.py`、`configs/notch_case.yaml`
- 变更：
  - 移除 `TwinningConfig.h_power`；
  - `load_config()` 新增 dataclass 字段过滤，旧配置中遗留键不再导致加载失败。

### 5) 回归测试补充（已完成）

- 文件：`tests/test_numerical_stability.py`
- 新增：
  - 正向剪切激活测试；
  - surrogate 默认冻结塑性场测试；
  - surrogate 接受后 CP 内变量同步测试。
- 结果：
  - 纯物理：`~9.96 step/s`
  - ML启用：`~20.42 step/s`
  - 加速比：`~2.05x`

### 3) GPU 全流程小规模检查

- 命令：
  - `scripts/run_all_checks.py --config configs/notch_case.yaml --device cuda --physics-steps 40 --ml-steps 40 --bench-steps 40 --train-epochs 3 --train-batch-size 8 --max-solid-drift 0.1 --min-speedup 1.05`
- 结果：
  - `passed = true`
  - `speedup ~1.80x`
  - `solid_fraction_abs_diff ~0.0039`

## 四、下一步可继续优化（未改动核心理论前提下）

1. 将力学子步从显式松弛改为更高效的线性求解器（如多重网格/FFT 预条件）  
2. 对腐蚀-扩散部分引入半隐式时间离散，提高大步长稳定性  
3. surrogate 从单步残差升级为多步一致性训练（teacher forcing + rollout loss）  
4. 输出保存异步化（I/O线程）以减少主求解阻塞  
5. 针对 RTX 30 系列补充更细粒度 profile（Nsight）并做 kernel 级优化  

## 五、本轮新增：在准确性约束下实现 10x+ 提速（已完成）

### 19) 扩散积分器升级为 STS（已完成）

- 文件：`mg_coupled_pf/config.py`、`mg_coupled_pf/simulator.py`
- 改进：
  - 新增 `numerics.diffusion_integrator`，支持 `subcycled_euler / sts`
  - 新增 STS 参数：
    - `diffusion_sts_nu`
    - `diffusion_sts_max_stages`
  - 在 `simulator` 中加入 stage 计划缓存，避免重复构造
  - 扩散更新重构为通用 `rhs` + stage 推进
- 效果：
  - 在高分辨率工况下，`dt=0.005` 时扩散 stage 数从保守设置下的 239 下降到 17（`nu=5e-4`）

### 20) 力学求解器自适应提前收敛（已完成）

- 文件：`mg_coupled_pf/config.py`、`mg_coupled_pf/mechanics.py`
- 改进：
  - 新增参数：
    - `mechanics_adaptive_substeps`
    - `mechanics_min_substeps`
    - `mechanics_residual_tol`
    - `mechanics_residual_rel_tol`
  - 在准静态力学迭代中依据残差提前停止，减少无效迭代

### 21) surrogate 物理约束增强（已完成）

- 文件：`mg_coupled_pf/simulator.py`、`mg_coupled_pf/ml/surrogate.py`
- 改进：
  - surrogate 有效性检查新增液相约束：液相 `eta/epspeq` 残留超阈值时拒绝
  - surrogate 输出后直接执行固相掩膜：`eta, epspeq` 仅保留在固相

### 22) 训练脚本大数据流式训练（已完成）

- 文件：`scripts/train_surrogate.py`
- 改进：
  - 支持 `--streaming`、`--num-workers`、`--max-pairs`
  - 快照对按需读取，降低内存峰值，便于高分辨率数据训练

### 23) 10x 对照试算结果（0.5 s 物理时长）

- 报告：`artifacts/reports/fast_physics_vs_baseline_0p5s_nu5e4.json`
- 对照：
  - 基线：`dt=1e-3`，500步，`configs/half_half_highres_ml_pure.yaml`（ML关闭）
  - 加速：`dt=5e-3`，100步，`configs/half_half_highres_fast_physics.yaml`（ML关闭）
- 结果：
  - 基线耗时：`88.93 s`
  - 加速耗时：`6.07 s`
  - 加速比：`14.64x`
  - 终态误差：
    - `phi MAE = 4.60e-09`
    - `cMg MAE = 9.28e-04`
    - `eta MAE = 0`
    - `epspeq MAE = 6.73e-07`
    - `solid_fraction abs diff = 0`

### 24) 5 s 长时稳定性试算（已完成）

- 运行目录：`artifacts/sim_notch/mg_half_half_tri_notch_highres_fast_physics`
- 结果摘要：
  - `dt=0.005 s`，`total_time=5 s`，`n_steps=1000`
  - 进度日志全程稳定，无 NaN/发散
  - 液相 `eta=0`，`cMg` 保持在 `[0,1]`，液相均值约 `2.40e-3`

### 25) ML 分支复测结论（本轮不作为默认交付）

- 报告：
  - `artifacts/reports/fastml_0p5s_report.json`
  - `artifacts/reports/fastml_retrained_0p5s_report.json`
- 结论：
  - 当前 full-state surrogate 在该高分辨率工况下仍会引入应力漂移风险
  - 相对“加速物理方案”额外提速不足且精度风险高
  - 默认交付采用 `fast_physics` 路线（准确性优先）

### 26) 架构继续优化：可复用的步长校准器（已完成）

- 文件：`scripts/calibrate_fast_dt.py`
- 作用：
  - 自动运行“基线 dt”与多个候选快 dt 的短程对照
  - 按 `c/phi/epspeq` MAE 阈值筛选可接受候选
  - 自动给出“满足精度约束下速度最快”的推荐 `dt`
- 本轮结果：
  - 报告：`artifacts/reports/dt_calibration_report.json`
  - 推荐：`dt=0.005 s`
  - 加速比约 `14.64x`

### 27) 架构继续优化：求解器统计可观测性（已完成）

- 文件：`mg_coupled_pf/simulator.py`、`scripts/run_notched_case.py`、`scripts/run_formal_comparison.py`
- 改进：
  - 新增 `solver_stats` 统计项：
    - `mech_predict_solve`
    - `mech_correct_solve`
    - `mech_correct_skipped_elastic`
  - 运行 JSON/报告中可直接查看优化触发率，便于后续定量迭代

### 28) 晶体塑性弹性捷径（可选开关，已完成）

- 文件：`mg_coupled_pf/config.py`、`mg_coupled_pf/crystal_plasticity.py`
- 改进：
  - 新增 `crystal_plasticity.elastic_shortcut`（默认 `false`）
  - 在过应力模型下若全域严格弹性，可跳过塑性增量与硬化更新（方程等价）
- 说明：
  - 默认关闭，不影响现有高精度主流程
  - 在弹性主导工况可开启进一步降耗

### 29) 前沿模型接入：FNO2D surrogate（已完成）

- 文件：`mg_coupled_pf/ml/surrogate.py`、`scripts/train_surrogate.py`、`mg_coupled_pf/config.py`、`mg_coupled_pf/simulator.py`
- 改进：
  - surrogate 支持 `model_arch` 多架构切换（`tiny_unet` / `fno2d`）
  - 保存模型时写入 `meta.model_arch + arch_kwargs`，加载时自动识别
  - 训练脚本新增参数：`--model-arch`、`--fno-width`、`--fno-modes-x/y`、`--fno-depth`
  - 配置新增 FNO 超参数字段

### 30) surrogate 推理架构基准脚本（已完成）

- 文件：`scripts/benchmark_surrogate_models.py`
- 作用：
  - 在指定分辨率、设备和超参数下对比 TinyUNet/FNO2D 的单步推理延迟
- 本轮实测（`512x1024`, RTX3060）：
  - 结果文件：`artifacts/reports/surrogate_arch_benchmark_4models.json`
  - TinyUNet（hidden=32）：约 `21.91 ms/step`
  - FNO2D（width=16,modes=12x8,depth=3）：约 `23.39 ms/step`
- 结论：
  - FNO2D 已接入，但当前硬件与超参数下尚未超过 TinyUNet 单步推理速度；
  - 后续价值在于潜在更高接受率/更低锚定频率。

### 31) FNO 训练稳定性兼容（已完成）

- 文件：`scripts/train_surrogate.py`、`mg_coupled_pf/ml/surrogate.py`
- 改进：
  - `fno2d` 训练时自动关闭 AMP（避免 CUDA `ComplexHalf` FFT 限制）
  - `fno2d` 推理时在 surrogate 内部禁用 autocast，保证频域算子稳定
- 验证：
  - 已完成 FNO 短程训练烟测与推理烟测（`run_notched_case` 可正常运行）

### 32) 新增前沿模型：AFNO2D 与 DW-UNet（已完成）

- 文件：`mg_coupled_pf/ml/surrogate.py`、`mg_coupled_pf/config.py`、`scripts/train_surrogate.py`
- 改进：
  - 新增 surrogate 架构：
    - `afno2d`（前沿频域算子，轻量化实现）
    - `dw_unet`（深度可分离卷积）
  - 训练/加载/推理链路全部支持新架构
  - 模型元信息自动保存与加载（避免架构错配）

### 33) 新增四模型统一基准（已完成）

- 文件：`scripts/benchmark_surrogate_models.py`
- 能力：
  - 支持一次性对比 `tiny_unet,dw_unet,fno2d,afno2d`
  - 输出最快架构与相对 tiny 的速度比
- 报告：
  - `artifacts/reports/surrogate_arch_benchmark_4models.json`
- 本轮实测（512x1024, RTX3060）：
  - `afno2d`（width=12,modes=8x6,depth=2）达到最快，约为 tiny 的 `1.60x` 推理速度

### 34) 长时精度门槛（<=2%）达成与配置收敛（已完成）

- 目标：在 `5.0 s` 物理时间内将最终误差控制在 `<=2%`，同时保持 ML 加速。
- 过程：
  - 先验证旧配置 `surrogate_delta_scale=0.02`：5s 出现长期漂移（`phi` 超 2%）。
  - 继续做参数收敛：将代理增量缩放降低到 `0.005`，漂移明显下降但 `phi` 仍约 2.5%。
  - 最终收敛到 `surrogate_delta_scale=0.003`（`anchor_physics_every=20`、`surrogate_update_mechanics_fields=false`）。
- 最终报告：`artifacts/reports/afno_scale0003_5s_report.json`
- 关键结果（5s）：
  - `final_field_metrics.phi.mae = 0.01594`（1.594%）
  - `final_field_metrics.c.mae = 0.01144`（1.144%）
  - `final_field_metrics.eta.mae = 0.00384`（0.384%）
  - `final_solid_fraction_abs_diff = 0.00224`（0.224%）
  - `speedup_physics_over_ml = 3.03x`
- 配置落地：
  - 已将 `configs/half_half_highres_ml_afno_scaled.yaml` 的 `surrogate_delta_scale` 更新为 `0.003`。
- 说明：
  - 使用项目虚拟环境运行（`.venv_gpu`）；系统 `D:\Anaconda\python.exe` 的 `numpy` 环境存在异常，不用于正式对照。

## 六、本轮补充：三重门控与训练一致化（2026-02-11）

### 35) surrogate 三重门控（已完成）

- 文件：`mg_coupled_pf/config.py`、`mg_coupled_pf/simulator.py`
- 新增：PDE 残差门控、能量门控、不确定性门控
- 结果：surrogate 接受判据从启发式阈值升级为物理约束优先

### 36) 自适应 rollout（已完成）

- 文件：`mg_coupled_pf/simulator.py`
- 新增：根据接受/拒绝连续统计动态调整 `rollout_every`
- 结果：在稳定区间自动提高加速倾向，失稳区间自动回收到保守策略

### 37) 训练物理损失一致化（已完成）

- 文件：`scripts/train_surrogate.py`
- 新增：`h(phi)*c` 守恒项、孪晶本征应变进入力学残差

### 38) 测试与烟测（已完成）

- 语法检查：`py_compile` 通过
- 测试：`python -m pytest -q tests`，`14 passed`
- 结果报告：`docs/本轮优化执行报告_20260211.md`

### 39) 力学加载模式显式化（已完成）

- 文件：`mg_coupled_pf/config.py`、`mg_coupled_pf/mechanics.py`、`scripts/train_surrogate.py`
- 改进：
  - 新增 `mechanics.loading_mode`：`eigenstrain / dirichlet_x`
  - 新增 `mechanics.dirichlet_right_displacement_um`
  - 位移场约束与线性系统向量约束解耦（避免 Krylov 残差向量误施加位移常值）
  - 训练损失中的外加应变项按加载模式一致化

### 40) 加载模式专项测试（已完成）

- 测试新增：`test_mechanics_dirichlet_x_boundary_enforced`
- 结果：`python -m pytest -q tests` -> `15 passed`

### 41) 加载模式基准（已完成）

- 脚本：`scripts/benchmark_loading_modes.py`
- 报告：`artifacts/reports/loading_mode_benchmark_20260211.json`
- 关键结论：
  - `dirichlet_x` 右边界位移误差 `3.58e-08 um`（边界约束生效）

## 七、本轮补充：耦合自洽修复与PDE一致化训练（2026-02-11 深夜）

### 42) η-φ 耦合顺序修复（已完成）

- 文件：`mg_coupled_pf/simulator.py`
- 修复点：
  - 孪晶 TDGL 推进由旧 `phi` 改为新 `phi_new` 计算 `h(phi)`。
  - `grad_coef_eta`、`twin_dw`、`tw_drive`、`langevin` 全部改为基于 `phi_new`。
- 影响：
  - 消除“先按固相推进再投影清零”的不自洽步骤。
  - 界面快速移动阶段的伪驱动被抑制，η 在液相内不会被错误激活。

### 43) 平面应变下 `sigma_h` 定义修复（已完成）

- 文件：`mg_coupled_pf/mechanics.py`
- 修复点：
  - 在 `plane_strain=True` 时显式计算 `sigma_zz = lambda*(eps_xx+eps_yy)`。
  - `sigma_h` 改为 `(sigma_xx + sigma_yy + sigma_zz)/3`。
- 影响：
  - 腐蚀迁移率中应力促进项不再系统性低估。

### 44) φ-IMEX 从常系数近似升级为变系数隐式（已完成）

- 文件：`mg_coupled_pf/simulator.py`
- 修复点：
  - 原方案：`mean(L_phi)` 形成常系数 Helmholtz。
  - 新方案：`(I - dt*div(kappa*L_phi*grad)) phi_new = rhs`，使用 `_solve_variable_diffusion_imex`。
  - PDE 残差评估同样改为 `+L*nonlin-div(kappa*L*grad(phi))` 形式。
- 影响：
  - 局部点蚀/应力导致的空间迁移率变化可被正确保留。

### 45) 孪晶梯度耦合项量纲统一（已完成）

- 文件：`mg_coupled_pf/simulator.py`
- 修复点：
  - `include_twin_grad_term_in_phi_variation` 路径中，`eta` 梯度统一使用 `um` 网格尺度（与 TDGL 主方程一致）。
- 影响：
  - 消除 `kappa_eta` 在 `m/um` 混用下的数量级错配风险。

### 46) surrogate 状态完备化 + 门控/执行一致化（已完成）

- 文件：`mg_coupled_pf/geometry.py`、`mg_coupled_pf/ml/surrogate.py`、`mg_coupled_pf/simulator.py`
- 修复点：
  - surrogate 输入输出扩展为 9 通道：`phi,c,eta,ux,uy,epspeq,epsp_xx,epsp_yy,epsp_xy`。
  - 主状态新增 `epsp_xx/yy/xy` 并与内部 `self.epsp` 双向同步。
  - surrogate 门控支持塑性张量在液相掩膜/增量阈值检查。
  - 若启用 `enable_surrogate_mechanics_correction`，门控阶段先计算“同一套力学校正结果”，避免“门控与执行系统不一致”。
  - `load_surrogate` 支持形状过滤加载，兼容旧权重。

### 47) 训练端加入离散 PDE 残差损失 + 旧快照兼容（已完成）

- 文件：`scripts/train_surrogate.py`
- 改进：
  - 新增参数：`--loss-pde-weight`。
  - 训练损失新增 `pde_loss`：联合约束 `phi/c/eta` 离散残差。
  - 力学损失由 `epspeq` 简化各向同性改为显式 `epsp_xx/yy/xy` 张量参与。
  - 旧快照缺失新通道时自动零填充，保证历史数据可继续训练。

### 48) 新增回归测试与结果（已完成）

- 新增测试：
  - `tests/test_numerical_stability.py::test_plane_strain_sigma_h_includes_sigma_zz`
  - `tests/test_surrogate_arches.py::test_predict_compatible_with_legacy_state_without_epsp_tensor_channels`
  - `tests/test_train_surrogate_loader.py::test_snapshot_loader_fills_missing_epsp_channels`
- 全量测试：
  - 命令：`python -m pytest -q`
  - 结果：`18 passed`

### 49) 小规模对照回归（已完成）

- 回归脚本：
  - `python scripts/run_notched_case.py --config configs/notch_case.yaml --device cpu --disable-ml --dt-s 1e-4 --total-time-s 5e-4 --save-interval-s 5e-4 --progress --progress-every 1 --no-render-intermediate-fields --render-final-clouds --render-grid-figure`
  - `python scripts/run_formal_comparison.py --config configs/notch_case.yaml --steps 6 --save-every 6 --device cpu --progress-every 3 --case-tag quick_regress --report-json artifacts/reports/quick_regress_report.json --report-md artifacts/reports/quick_regress_report.md`
- 结果：
  - `final_clouds`、`grid`、`history`、`report` 均正常输出。
  - 6步回归中物理/ML 最终标量差异接近机器精度（`solid_fraction` 差异 0）。

### 50) 参考论文与本轮对齐点

- PINO（PDE 约束训练）：https://arxiv.org/abs/2111.03794
- FNO（神经算子基线）：https://arxiv.org/abs/2010.08895
- AFNO（高效频域 token mixing）：https://arxiv.org/abs/2111.13587
- SAV（能量稳定框架）：https://www.math.purdue.edu/~shen7/pub/SXY17.pdf
- Learning Preconditioners for CG：
  - https://proceedings.mlr.press/v202/li23e.html
- Convex Splitting 相关：
  - https://epubs.siam.org/doi/10.1137/080738143

### 51) 边界条件离散修复（已完成）

- 文件：`mg_coupled_pf/operators.py`、`mg_coupled_pf/config.py`
- 改进：
  - 新增标量边界条件参数 `numerics.scalar_bc`（`neumann/periodic/dirichlet0`）
  - 均匀网格默认从 `replicate` 改为 `reflect`（Neumann 零法向梯度）
  - `grad_xy/divergence/laplacian` 增加 `bc` 入口
- 作用：
  - 避免边界导数伪泄漏，提高零通量语义一致性

### 52) 变系数扩散算子改为守恒有限体积离散（已完成）

- 文件：`mg_coupled_pf/simulator.py`
- 改进：
  - 新增 `_div_diffusive_fv()`，使用面通量 + harmonic mean 离散 `div(D grad u)`
  - `_solve_variable_diffusion_imex()` 改用该守恒离散
  - `_diffusion_rhs()` 主扩散项改为守恒离散
  - `phi` 显式路径与 PDE 残差中的变系数扩散项同步改为该离散
- 作用：
  - 提高变系数扩散离散的对称性与守恒性，减少 PCG 前提偏离

### 53) clamp 侵入性降低（已完成）

- 文件：`mg_coupled_pf/simulator.py`
- 改进：
  - 扩散 STS 子阶段去除逐 stage clamp，只保留 NaN 防护
  - 子循环结束后统一一次 clamp 到物理区间
- 作用：
  - 降低子阶段投影对动力学的持续扰动

### 54) 力学隔步更新改为“周期 + 自适应触发”混合（已完成）

- 文件：`mg_coupled_pf/config.py`、`mg_coupled_pf/simulator.py`
- 新增参数：
  - `numerics.mechanics_trigger_phi_max_delta`
  - `numerics.mechanics_trigger_eta_max_delta`
- 机制：
  - 当 `mechanics_update_every>1` 时，若 `phi/eta` 相对上次力学求解变化超阈值，提前触发力学更新
- 作用：
  - 降低过期应力驱动造成的形核/腐蚀判定滞后

### 55) 训练离散边界一致化（已完成）

- 文件：`scripts/train_surrogate.py`
- 改进：
  - 训练残差近似中的中心差分 padding 从 replicate 改为 reflect（与主求解器默认 Neumann 一致）

### 56) 本轮新增测试与回归（已完成）

- 新增测试：
  - `tests/test_operators_nonuniform.py::test_uniform_neumann_boundary_zero_normal_gradient`
  - `tests/test_numerical_stability.py::test_diffusion_rhs_conservative_for_zero_flux_case`
  - `tests/test_numerical_stability.py::test_mechanics_adaptive_trigger_updates_early`
- 全量测试：
  - 命令：`python -m pytest -q`
  - 结果：`21 passed`
- 小规模对照回归：
  - 报告：`artifacts/reports/quick_regress_v2_report.json`
  - 结果：运行正常，物理/ML 最终关键标量差异接近 0（`solid_fraction` 差异 0）

### 57) 标量隐式线性求解器鲁棒性增强（已完成）

- 文件：`mg_coupled_pf/config.py`、`mg_coupled_pf/simulator.py`
- 新增配置：`numerics.scalar_linear_solver = auto|pcg|bicgstab`
- 机制：
  - `auto`：先尝试 PCG，若未收敛自动回退 BiCGStab
  - 统计项新增：`scalar_pcg_calls/converged`、`scalar_bicgstab_calls/converged`、`scalar_solver_fallback`
- 作用：
  - 在非理想离散/强变系数场景下提升稳健性，避免单一 PCG 假设失效

### 58) 求解器回退测试（已完成）

- 新增测试：`test_scalar_linear_solver_auto_fallback_to_bicgstab`
- 结果：已纳入全量测试并通过

### 59) 力学边界条件升级为按轴可分离（已完成）

- 文件：`mg_coupled_pf/operators.py`、`mg_coupled_pf/config.py`、`mg_coupled_pf/mechanics.py`、`mg_coupled_pf/simulator.py`
- 改进：
  - `operators` 支持 `bc=("x_bc","y_bc")` 与 `bc={"x":"...","y":"..."}` 两种按轴写法；
  - 新增 `mechanics.mechanics_bc_x/mechanics_bc_y`，若配置则覆盖 `mechanics.mechanics_bc`；
  - 力学残差与力学梯度/散度统一走力学专用 BC，避免与标量场 BC 混用。
- 作用：
  - 允许逐轴定义力学离散边界，减少“单字符串边界”带来的语义混叠。

### 60) surrogate 位置感知与位移硬投影（已完成）

- 文件：`mg_coupled_pf/ml/surrogate.py`、`mg_coupled_pf/config.py`、`mg_coupled_pf/simulator.py`、`scripts/train_surrogate.py`
- 改进：
  - TinyUNet / DWUNet 新增坐标通道开关（`x/L, y/L`）；
  - 新增配置：`ml.surrogate_add_coord_features`；
  - surrogate 推理后可硬投影位移约束：
    - `ux(left)=0`
    - `ux(right)=u_right`（Dirichlet 加载模式）
    - `uy(0,0)=0`
  - 新增配置：`ml.surrogate_enforce_displacement_projection`。
- 作用：
  - 改善 surrogate 对边界与绝对位置的识别能力，提升可接受率与力学一致性。

### 61) cMg 质量门控与质量投影（已完成）

- 文件：`mg_coupled_pf/config.py`、`mg_coupled_pf/simulator.py`
- 改进：
  - 新增 surrogate 质量门控：
    - `ml.enable_mass_gate`
    - `ml.mass_abs_delta_max`
    - `ml.mass_rel_delta_max`
  - 新增质量投影：
    - `numerics.concentration_mass_projection`
    - `numerics.concentration_mass_projection_iters`
    - `ml.enforce_mass_projection_on_accept`
  - 统计项新增：
    - `ml_reject_mass`
    - `mass_projection_applied`
- 作用：
  - 显式约束 surrogate 单步质量漂移，并支持物理步/代理步后的均值回投影。

### 62) 本轮新增测试与结果（已完成）

- 新增测试：
  - `tests/test_surrogate_arches.py::test_predict_applies_mechanics_boundary_projection`
  - `tests/test_numerical_stability.py::test_surrogate_gate_rejects_by_mass_delta`
  - `tests/test_numerical_stability.py::test_concentration_mass_projection_applied_in_physics_step`
  - `tests/test_operators_nonuniform.py::test_axis_wise_bc_tuple_and_dict_are_consistent`
- 全量测试：
  - 命令：`python -m pytest -q`
  - 结果：`26 passed`
- 小规模运行回归：
  - 命令：`python scripts/run_notched_case.py --override-steps 3 --override-save-every 1 --device cpu --disable-ml`
  - 结果：`figures/grid/final_clouds` 均正常生成，`final_clouds_dir_exists=true`

### 63) phi 方程恢复 Allen–Cahn 正确形式（已完成）

- 文件：`mg_coupled_pf/simulator.py`
- 改进：
  - 将 `phi` 梯度项由错误的 `div(L_phi * kappa_phi * grad(phi))` 改为 `L_phi * (kappa_phi * laplacian(phi))`。
  - 显式分支更新为：
    - `phi_rhs = -L_phi * phi_nonlin + L_phi * (kappa_phi * lap_phi)`
  - IMEX 分支改为 `L0` 分裂：
    - 隐式：`L0 * kappa_phi * lap(phi^{n+1})`
    - 显式补偿：`(L_phi-L0) * kappa_phi * lap(phi^n)`
- 作用：
  - 修复方程级物理错误，避免引入 `grad(L_phi)·grad(phi)` 假项。

### 64) 力学非零 Dirichlet 边界导数一致性修复（已完成）

- 文件：`mg_coupled_pf/mechanics.py`、`mg_coupled_pf/operators.py`
- 改进：
  - `operators` 新增按侧 Dirichlet 值支持（`x_left/x_right/y_bottom/y_top`）。
  - `mechanics._disp_strain_only()` 在 `loading_mode=dirichlet_x` 下，`ux` 梯度离散显式传入：
    - `x_left=0`
    - `x_right=dirichlet_right_ux`
- 作用：
  - 避免右边界非零位移在导数离散中被错误当成 0，降低边界应变/应力污染。

### 65) surrogate 与 gate 的硬 clamp 去除（已完成）

- 文件：`mg_coupled_pf/ml/surrogate.py`、`mg_coupled_pf/simulator.py`、`mg_coupled_pf/operators.py`
- 改进：
  - `surrogate.predict()` 将 `phi/c/eta` 的 `hard clamp` 改为可微软投影（soft projection）。
  - `_compute_pde_residuals()` 去除对候选 `phi/c/eta` 的硬截断，改为 `nan_to_num` + 原值残差评估。
  - 新增 `operators` 的可选参数 `clamp_input=False`，用于残差计算时避免隐式二次截断。
  - `_sanitize_state()` 与 `_limit_surrogate_update()` 对 `phi/c/eta` 使用软投影替代硬截断。
- 作用：
  - 降低 clamp 对守恒与残差判据的干扰，使门控更贴近真实候选状态。

### 66) 本轮新增测试与结果（已完成）

- 新增测试：
  - `tests/test_numerical_stability.py::test_phi_residual_uses_allen_cahn_l_times_laplacian_form`
  - `tests/test_numerical_stability.py::test_mechanics_dirichlet_nonzero_right_value_enters_ux_gradient`
  - `tests/test_operators_nonuniform.py::test_dirichlet_side_values_are_respected_in_uniform_derivative`
- 全量测试：
  - 命令：`python -m pytest -q`
  - 结果：`29 passed`
- 小规模算例回归：
  - 命令：`python scripts/run_notched_case.py --override-steps 3 --override-save-every 1 --device cpu --disable-ml --no-render-intermediate-fields --no-render-final-clouds --no-render-grid-figure`
  - 结果：运行成功，输出目录与 history 正常生成。

### 67) 孪晶梯度能对 phi 变分符号修正（已完成）

- 文件：`mg_coupled_pf/simulator.py`
- 改进：
  - `include_twin_grad_term_in_phi_variation` 分支中，
    - 由 `phi_nonlin = phi_nonlin - hphi_d * twin_grad_e`
    - 修正为 `phi_nonlin = phi_nonlin + hphi_d * twin_grad_e`
- 说明：
  - 与自由能项 `+0.5*kappa_eta*h(phi)*|grad eta|^2` 的变分符号保持一致，避免 PDE 与 energy gate 自相矛盾。

### 68) 机械-phi 耦合与能量门控一致化（已完成）

- 文件：`mg_coupled_pf/config.py`、`mg_coupled_pf/simulator.py`
- 新增配置：
  - `corrosion.include_mech_term_in_free_energy`（默认 `true`）
- 改进：
  - 当 `include_mech_term_in_phi_variation=true` 且 `include_mech_term_in_free_energy=true` 时，
    - 自由能中加入一致的近似耦合项：`-h(phi) * e_mech`
  - 若用户显式关闭该能量项，则自动跳过 energy gate，并记录计数：
    - `ml_energy_gate_skipped_nonvariational`

### 69) phi-IMEX 的 L0 选取改为可配置稳健策略（已完成）

- 文件：`mg_coupled_pf/config.py`、`mg_coupled_pf/simulator.py`
- 新增配置：
  - `numerics.phi_imex_l0_strategy`：`max|p95|mean`
  - `numerics.phi_imex_l0_quantile`
  - `numerics.phi_imex_l0_safety`
- 默认行为：
  - `max` + `1.05` 安全系数（优先稳健）

### 70) Python 可安装包结构补齐（已完成）

- 新增文件：`pyproject.toml`
- 作用：
  - 支持 `pip install -e .`
  - 统一 IDE / CLI 的导入路径，降低 `ModuleNotFoundError` 风险

### 71) 本轮新增测试与验证（已完成）

- 新增测试：
  - `test_phi_twin_gradient_variation_sign_consistent`
  - `test_free_energy_includes_mech_phi_coupling_when_enabled`
  - `test_energy_gate_auto_skips_when_nonvariational_mech_term_enabled`
  - `test_phi_imex_l0_strategy_max_not_lower_than_mean`
- 全量测试：
  - 命令：`python -m pytest -q`
  - 结果：`33 passed`
- 可安装性验证：
  - 命令：`python -m pip install -e .`
  - 结果：安装成功
- 小规模算例回归：
  - 命令：`python scripts/run_notched_case.py --override-steps 3 --override-save-every 1 --device cpu --disable-ml --no-render-intermediate-fields --no-render-final-clouds --no-render-grid-figure`
  - 结果：运行成功，输出目录正常。

### 72) 力学专用 ML 初值器（已完成）

- 新增文件：
  - `mg_coupled_pf/ml/mech_warmstart.py`
  - `scripts/train_mechanics_warmstart.py`
  - `tests/test_mechanics_warmstart.py`
- 配置扩展：
  - `ml.mechanics_warmstart_enabled`
  - `ml.mechanics_warmstart_model_path`
  - `ml.mechanics_warmstart_hidden`
  - `ml.mechanics_warmstart_add_coord_features`
- 求解器接入：
  - `simulator._physics_step()` 中当 `mechanics_use_ml_initial_guess=true` 时，
    优先使用 mechanics warmstart 预测 `ux/uy` 作为初值；
  - 无 warmstart 模型时回退到原有 surrogate 初值逻辑。
- 新增统计项：
  - `mech_ml_initial_guess_mech_warmstart`
  - `mech_ml_initial_guess_surrogate`

### 73) 力学初值器烟雾验证（已完成）

- 训练烟雾：
  - `python scripts/train_mechanics_warmstart.py --config configs/notch_case.yaml --snapshots-dir artifacts/sim_notch/mg_notch_2d/snapshots --epochs 1 --batch-size 1 --max-samples 2 --device cpu --disable-torch-compile`
  - 结果：成功生成 `artifacts/ml/mech_warmstart_latest.pt`
- 推理接入烟雾：
  - 使用临时脚本运行 2 步，统计显示：
    - `mech_ml_initial_guess_used=2`
    - `mech_ml_initial_guess_mech_warmstart=2`
    - `mech_ml_initial_guess_surrogate=0`

### 74) 全量测试结果更新（已完成）

- 命令：`python -m pytest -q`
- 结果：`35 passed`

### 75) 能量门控改为 E_gate / E_diag 双轨（已完成）

- 文件：`mg_coupled_pf/simulator.py`、`mg_coupled_pf/config.py`
- 改进：
  - `_compute_free_energy(..., for_gate=True|False)` 支持两套能量：
    - `E_gate`：仅保留与当前变分驱动一致的核心项；
    - `E_diag`：诊断用总能量（含弹性能等）。
  - `ml.energy_gate_use_variational_core` 默认 `true`，energy gate 默认使用 `E_gate`。
  - `corrosion.include_mech_term_in_free_energy` 默认改为 `false`，与 mobility-only 默认路线一致。

### 76) c 方程与化学自由能一致化（已完成）

- 文件：`mg_coupled_pf/simulator.py`、`mg_coupled_pf/config.py`
- 新增配置：
  - `corrosion.concentration_use_mu_form`（默认 `true`）
- 改进：
  - 扩散默认采用化学势一致写法：
    - `mu = A_mpa*(c - h(phi)*(cs-cl) - cl)`
    - `c_t = div(M*grad(mu))`, `M = D/A_mpa`
  - 保留旧路径作为对照（`concentration_use_mu_form=false`）。

### 77) 力学散度边界修正为 traction-free 通量闭合（已完成）

- 文件：`mg_coupled_pf/mechanics.py`、`mg_coupled_pf/simulator.py`
- 改进：
  - 新增力学应力散度 `stress_divergence()`（FV 通量形式）。
  - 在 `mechanics_bc=neumann` 轴上按 `sigma·n=0` 处理边界面通量。
  - 力学线性算子、右端项、松弛残差与门控残差统一使用该散度定义。

### 78) 新增测试与回归（已完成）

- 更新/新增测试：
  - `test_energy_gate_auto_skips_when_nonvariational_mech_term_enabled`（适配 gate 模式参数）
  - `test_diffusion_rhs_mu_form_matches_explicit_mu_divergence`
  - `test_mechanics_stress_divergence_uses_traction_free_on_neumann_boundaries`
- 全量测试：
  - 命令：`python -m pytest -q`
  - 结果：`37 passed`

### 79) 核心路径去硬阈值投影（已完成）

- 文件：`mg_coupled_pf/simulator.py`、`mg_coupled_pf/geometry.py`、`mg_coupled_pf/mechanics.py`
- 改进：
  - 主求解路径移除 `solid_indicator(phi)` 硬截断，统一改为连续权重 `h(phi)`。
  - `eta_new`、`_sanitize_state()`、门控液相约束、力学残差加权均改为连续权重。
  - 诊断 `avg_eta` 改为 `mean(h(eta))`，显式表征孪晶体积分数。

### 80) PDE residual gate 无量纲化（已完成）

- 文件：`mg_coupled_pf/simulator.py`
- 改进：
  - `pde_phi/pde_c/pde_eta/pde_mech` 全部改为无量纲指标。
  - 门控阈值 `ml.pde_residual_*_abs_max` 语义更新为“无量纲阈值”。

### 81) 界面厚度与 pit 参数语义统一（已完成）

- 文件：`mg_coupled_pf/config.py`、`mg_coupled_pf/geometry.py`、`mg_coupled_pf/simulator.py`
- 改进：
  - `corrosion.interface_thickness_um<=0` 时继承 `domain.interface_width_um`；
  - 新增 `domain.initial_pit_sigma_um`；
  - 旧 `initial_pit_radius_um` 保留兼容并转换为 `sigma=radius/sqrt(2)`；
  - `_omega_kappa_phi()` 与几何初值共用统一界面厚度来源。

### 82) L0 单位换算与 CP 最小强度耦合（已完成）

- 文件：`mg_coupled_pf/config.py`、`mg_coupled_pf/simulator.py`、`mg_coupled_pf/crystal_plasticity.py`
- 改进：
  - 新增 `corrosion.L0_unit`（`1_over_MPa_s` / `1_over_Pa_s`）；
  - 腐蚀迁移率中按单位自动换算；
  - CP 更新新增相依赖强度缩放：
    - `use_phase_dependent_strength`
    - `matrix/twin_crss_scale`
    - `matrix/twin_hardening_scale`

### 83) 本轮测试结果（已完成）

- 命令：`python -m pytest tests/test_numerical_stability.py -q`
- 结果：`26 passed`
- 命令：`python -m pytest -q`
- 结果：`38 passed`

### 84) 第二轮扩展：多孪晶变体主链路接入（已完成）

- 目标：在保持单变体兼容的前提下，打通多变体 `eta` 在力学、孪晶演化、门控清洗路径中的数据流。
- 关键改动：
  - `mg_coupled_pf/config.py`
    - `TwinningConfig` 新增：`n_variants`、`twin_variant_indices`、`variant_competition_MPa`、`enforce_variant_sum_le_one`。
  - `mg_coupled_pf/crystallography.py`
    - `resolve_twin_pair_xy(..., variant_index=...)` 支持显式变体索引。
  - `mg_coupled_pf/mechanics.py`
    - 构建 `twin_variant_pairs`；
    - `twin_strain()` 支持 `eta_variants`；
    - `solve_quasi_static()` 与 `_strain_from_displacement()` 全链路接入 `eta_variants`。
  - `mg_coupled_pf/simulator.py`
    - 新增多变体状态管理：
      - `_collect_eta_variants_from_state`
      - `_sync_eta_variants_to_state`
      - `_enforce_eta_variant_constraints`
      - `_distribute_total_eta_to_variants`
    - 力学求解调用统一传入 `eta_variants`；
    - 孪晶 TDGL 改为“按变体独立更新 + 可选竞争项 + 和约束”；
    - `epspeq_dot_twin` 按变体本征应变增量求和；
    - surrogate 路径中对 `eta` 与 `eta_v*` 做一致性回填。
  - `mg_coupled_pf/validation.py`
    - 增加 `n_variants/twin_variant_indices` 合法性审计。

### 85) 第二轮扩展测试（已完成）

- 全量测试：
  - 命令：`$env:PYTHONPATH='.'; pytest -q`
  - 结果：`58 passed`
- 配置审计：
  - 命令：`$env:PYTHONPATH='.'; python scripts/audit_config.py --config configs/notch_case.yaml --strict --output artifacts/reports/config_audit_round2.json`
  - 结果：`PASS (errors=0, warnings=1)`
- 综合检查：
  - 命令：`$env:PYTHONPATH='.'; python scripts/run_all_checks.py`
  - 结果：`passed=true`
- 多变体烟囱试算（3步）：
  - 结果：`eta == eta_v1 + eta_v2` 最大误差 `0.0`（脚本输出 `ok ... 0.0`）。

### 86) 第三轮扩展：surrogate 输出模式显式化 + 局部 PDE 门控（已完成）

- 文件：
  - `mg_coupled_pf/config.py`
  - `mg_coupled_pf/ml/surrogate.py`
  - `mg_coupled_pf/simulator.py`
  - `mg_coupled_pf/validation.py`
- 改进：
  - 新增 `ml.surrogate_output_mode`：
    - `delta`（默认，`next = current + delta`）
    - `absolute`（兼容模式，`next = model_output`）
  - 新增局部 PDE 热点门控参数：
    - `ml.enable_local_pde_gate`
    - `ml.local_pde_exceed_frac_max`
    - `ml.local_pde_phi_abs_max`
    - `ml.local_pde_c_abs_max`
    - `ml.local_pde_eta_abs_max`
    - `ml.local_pde_mech_abs_max`
  - 门控逻辑升级：
    - 在已有全局无量纲残差门控之外，增加“超阈值面积占比”拒绝机制；
    - 防止局部高残差被全局均值掩盖。
  - 进度输出新增 `Lhot`（局部残差热点比例最大值）。

### 87) 第三轮测试（已完成）

- 全量测试：
  - 命令：`$env:PYTHONPATH='.'; pytest -q`
  - 结果：`60 passed`
- 综合检查：
  - 命令：`$env:PYTHONPATH='.'; python scripts/run_all_checks.py`
  - 结果：`passed=true`

### 88) 第四轮扩展：跨尺度 ML 与反向设计子系统（已完成）

- 新增包：`mg_coupled_pf/multiscale/`
  - `features.py`：微结构场张量提取、描述符提取
  - `dataset.py`：多 case 快照构建 `micro(t) -> macro(t+ΔT)` 数据集
  - `models.py`：`MacroCorrosionPredictor`（场编码 + 描述符融合 + 不确定性头）
  - `train.py`：训练器、标准化、评估
  - `inverse_design.py`：基于 surrogate 的 CEM 反向设计
- 新增脚本：
  - `scripts/build_multiscale_dataset.py`
  - `scripts/train_multiscale_macro.py`
  - `scripts/predict_multiscale_macro.py`
  - `scripts/inverse_design_multiscale.py`
  - `scripts/count_codebase.py`
- 新增测试：
  - `tests/test_multiscale_pipeline.py`（数据集构建、训练、反向设计通路）

### 89) 第四轮测试（已完成）

- 全量测试：
  - 命令：`$env:PYTHONPATH='.'; pytest -q`
  - 结果：`63 passed`
- 配置审计：
  - 命令：`$env:PYTHONPATH='.'; python scripts/audit_config.py --config configs/notch_case.yaml --strict --output artifacts/reports/config_audit_round3.json`
  - 结果：`PASS (errors=0, warnings=1)`

### 90) 第五轮扩展：高级跨尺度架构（U-AFNO + 多保真）已完成

- 新增模块：
  - `mg_coupled_pf/multiscale/advanced_models.py`
  - `mg_coupled_pf/multiscale/advanced_train.py`
  - `mg_coupled_pf/multiscale/physics_metrics.py`
  - `mg_coupled_pf/multiscale/visualization.py`
  - `mg_coupled_pf/multiscale/data_generation.py`
- 新增脚本：
  - `scripts/generate_physics_multiscale_cases.py`
  - `scripts/build_multifidelity_dataset.py`
  - `scripts/train_multiscale_advanced.py`
  - `scripts/evaluate_multiscale_advanced.py`
  - `scripts/export_phasefield_theory_params.py`
- 新增测试：
  - `tests/test_multifidelity_advanced.py`

### 91) 第五轮：物理一致性宏观正确性指标（PCI）已落地

- 指标构成：
  - 目标物理边界越界率
  - 同算例时序单调一致率
  - 2σ 不确定性覆盖率校准
- 输出位置：
  - 训练报告 JSON：`physics_metrics`
  - 评估报告 JSON：`physics_metrics`
- 说明：
  - 在“高精度宏观标签稀缺”条件下，PCI 用于补足 MAE/RMSE 的物理可解释性。

### 92) 第五轮测试（已完成）

- 新增模块测试：
  - 命令：`$env:PYTHONPATH='.'; pytest -q tests/test_multifidelity_advanced.py`
  - 结果：`2 passed`
- 全量回归：
  - 命令：`$env:PYTHONPATH='.'; pytest -q`
  - 结果：`65 passed`

### 93) 小规模真实流程试跑（已完成）

- 多保真数据集构建：
  - 命令：
    - `python scripts/build_multifidelity_dataset.py --cases-root artifacts/sim_notch --pattern mg_notch_2d* --horizon-steps 1 --frame-stride 4 --max-samples-per-case 8 --target-h 96 --target-w 96 --low-target-h 48 --low-target-w 48 --high-fidelity-ratio 0.35 --seed 7 --output artifacts/ml/multifidelity_dataset_round2.npz`
  - 结果：
    - `n_samples=7`
    - `high_ratio_actual=0.142857`
- 高级模型训练：
  - 命令：
    - `python scripts/train_multiscale_advanced.py --dataset artifacts/ml/multifidelity_dataset_round2.npz --output-model artifacts/ml/multiscale_advanced_round2.pt --epochs 8 --batch-size 4 --lr 3e-4 --train-split 0.8 --model-name multifidelity_uafno --width 32 --depth 2 --afno-blocks 2 --modes-x 12 --modes-y 10 --device auto --output-report-json artifacts/reports/multiscale_advanced_round2_report.json --output-report-md artifacts/reports/multiscale_advanced_round2_report.md --fig-dir artifacts/reports/multiscale_advanced_round2_figs`
  - 结果：
    - `PCI=0.6381`
    - `RMSE=455.03`
    - `MAE=192.02`
- 独立评估：
  - 命令：
    - `python scripts/evaluate_multiscale_advanced.py --model artifacts/ml/multiscale_advanced_round2.pt --dataset artifacts/ml/multifidelity_dataset_round2.npz --output artifacts/reports/multiscale_advanced_round2_eval.json --device auto`
  - 结果：
    - `r2=0.2867`
    - `overall_violation_rate=0.0`
    - `overall_monotonic_score=0.0`（样本太少，后续需扩大数据规模）

### 94) 相场理论与全局参数总表（已自动化）

- 导出脚本：
  - `scripts/export_phasefield_theory_params.py`
- 输出文档：
  - `docs/相场理论与参数总表.md`
- 执行结果：
  - 成功生成，`chars=17835`

### 95) 论文对齐核查文档（已完成）

- 新增文档：
  - `docs/论文对齐与理论一致性核查_20260218.md`
- 内容：
  - FNO/PINO/U-AFNO/Phase-Field DeepONet/SCC/Mg腐蚀/CP-TPF 论文对齐表；
  - 当前实现与论文模型的一致项与工程近似项。

### 96) 第二阶段：主动学习闭环（已完成）

- 新增模块：
  - `mg_coupled_pf/multiscale/active_learning.py`
- 新增脚本：
  - `scripts/run_active_learning_multiscale.py`
- 新增测试：
  - `tests/test_active_learning_loop.py`
- 小规模实测命令：
  - `python scripts/run_active_learning_multiscale.py --config configs/notch_case.yaml --var domain.notch_depth_um:35:85 --var domain.notch_half_opening_um:18:55 --var corrosion.pitting_alpha:0.2:1.0 --rounds 2 --initial-cases 4 --new-cases-per-round 2 --candidate-pool 12 --sim-steps 120 --sim-save-every 20 --target-h 96 --target-w 96 --low-target-h 48 --low-target-w 48 --high-fidelity-ratio 0.35 --epochs 6 --batch-size 8 --lr 3e-4 --model-width 32 --model-depth 2 --afno-blocks 2 --device auto --output-root artifacts/active_learning_stage2 --output-json artifacts/reports/active_learning_stage2_report.json --output-fig artifacts/reports/active_learning_stage2_progress.png`
- 输出：
  - `artifacts/reports/active_learning_stage2_report.json`
  - `artifacts/reports/active_learning_stage2_progress.png`

### 97) 第三阶段：闭环反向设计（已完成）

- 新增模块：
  - `mg_coupled_pf/multiscale/closed_loop_design.py`
- 新增脚本：
  - `scripts/run_closed_loop_design.py`
- 新增测试：
  - `tests/test_closed_loop_design.py`
- 实测命令：
  - `python scripts/run_closed_loop_design.py --config configs/notch_case.yaml --model artifacts/active_learning_stage2/advanced_model_latest.pt --var domain.notch_depth_um:35:85 --var domain.notch_half_opening_um:18:55 --var corrosion.pitting_alpha:0.2:1.0 --weight corrosion_loss:-1.0 --weight penetration_x_ratio:-1.0 --weight sigma_h_max_solid:-0.2 --weight epspeq_mean:-0.1 --weight twin_fraction:0.05 --candidate-pool 20 --surrogate-topk 6 --physics-verify-topk 3 --local-refine-trials 4 --sim-steps 140 --sim-save-every 28 --target-h 96 --target-w 96 --device auto --seed 19 --output-root artifacts/closed_loop_stage3 --output-json artifacts/reports/closed_loop_stage3_report.json --output-fig artifacts/reports/closed_loop_stage3_scores.png`
- 输出：
  - `artifacts/reports/closed_loop_stage3_report.json`
  - `artifacts/reports/closed_loop_stage3_scores.png`
- 本轮最优参数（真实物理验证）：
  - `notch_depth_um=68.9372`
  - `notch_half_opening_um=18.0`
  - `pitting_alpha=0.2456`

### 98) 本轮总回归测试（已完成）

- 命令：
  - `python -m pytest -q`
- 结果：
  - `67 passed`
