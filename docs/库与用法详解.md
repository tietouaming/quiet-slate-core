# 项目库与用法详解（中文）

## 1. 文档目的与适用范围
本文件用于完整说明本项目中使用到的 Python 库、作用位置、关键 API 和常见使用方式。
适用对象：
- 需要复现实验环境的使用者
- 需要二次开发/重构代码的开发者
- 需要排查环境与依赖问题的维护者

说明：项目包含“核心相场仿真”与“可选工具脚本”两大部分，依赖也分为核心依赖与可选依赖。

## 2. 依赖分层总览

## 2.1 本轮核心接口变化（2026-02-14）
- `mg_coupled_pf/simulator.py`
  - 新增状态通道：`epspeq_slip`、`epspeq_twin`、`epspeq_dot_slip`、`epspeq_dot_twin`
  - 总等效塑性速率采用：`epspeq_dot = epspeq_dot_slip + w_twin * epspeq_dot_twin`
- `mg_coupled_pf/mechanics.py`
  - `constitutive_stress(...)` 新增固相应力输出：`sigma_*_solid`、`sigma_h_solid`
  - 各向异性 `plane_strain=False` 时改为平面应力 Schur 消元
- `mg_coupled_pf/crystal_plasticity.py`
  - CP 内部变量从单一 `g` 升级为 `g_parent/g_twin` 与 `gamma_accum_parent/gamma_accum_twin`
  - 同时保留兼容输出 `g`、`gamma_accum`
- `mg_coupled_pf/config.py`
  - 新增：`corrosion.interface_thickness_definition`
  - 新增：`corrosion.use_solid_sigma_for_corrosion`
  - 新增：`corrosion.epspeq_twin_weight`

### 2.1 核心仿真依赖（必须）
- `torch`：核心张量计算、GPU 加速、神经网络模块
- `numpy`：数组运算、随机场生成、与文件格式交互
- `pyyaml`：读取 YAML 配置文件
- `matplotlib`：输出网格图与场云图
- `pytest`：测试执行（建议但非运行主流程必需）

### 2.2 可选工具依赖（按脚本启用）
- `Pillow`（`PIL`）：图像读取、裁剪、空白检测
- `pywin32`（`win32com`）：调用 Word / PowerPoint COM 接口提取公式图
- `pix2tex`：公式图片 OCR 到 LaTeX
- `requests`：网页抓取 HTTP 请求
- `beautifulsoup4`：HTML 解析
- `tqdm`：命令行进度条
- `pycryptodome` 或 `pycrypto` 兼容接口：AES 解密（抓取脚本的可选逻辑）

### 2.3 Python 标准库（大量使用）
- `argparse`、`json`、`csv`、`pathlib`、`time`、`math`、`dataclasses`
- `subprocess`、`multiprocessing`、`itertools`
- `urllib.parse`、`urllib.robotparser`

## 3. 各库详细说明（含项目内使用位置）

## 3.0 配置审计与质量门控（新增）
用途：
- 在仿真/训练前做“物理一致性 + 数值稳定性”预检查；
- 统一输出结构化审计报告，供批处理与 CI 使用；
- 在 strict 模式下直接阻断错误配置。

主要文件：
- `mg_coupled_pf/validation.py`
- `scripts/audit_config.py`
- `scripts/run_notched_case.py`（支持 `--audit-config/--strict-audit`）

核心接口：
- `audit_config(cfg, config_path=...)`
- `save_audit_report(report, path)`
- `summarize_audit_report(report)`

## 3.1 torch（PyTorch）
用途：
- 主求解器数值计算（相场、扩散、力学、晶体塑性）
- surrogate 网络构建/训练/推理
- GPU 与混合精度加速

主要使用文件：
- `mg_coupled_pf/simulator.py`
- `mg_coupled_pf/operators.py`
- `mg_coupled_pf/mechanics.py`
- `mg_coupled_pf/crystal_plasticity.py`
- `mg_coupled_pf/ml/surrogate.py`
- `scripts/train_surrogate.py`

常用 API：
- 张量与设备：`torch.tensor`, `torch.device`, `tensor.to(...)`
- 自动混合精度：`torch.autocast`
- 推理模式：`torch.inference_mode`
- CUDA 同步：`torch.cuda.synchronize`
- 网络模块：`torch.nn`, `torch.nn.functional`
- 模型保存/加载：`torch.save`, `torch.load`
- 编译优化：`torch.compile`（按平台条件启用）

注意事项：
- Windows + CUDA 场景下 `torch.compile` 可能受后端限制，代码内已做降级。
- FNO/AFNO 频域算子在部分场景需禁用 AMP，避免复杂数精度问题。

## 3.2 numpy
用途：
- 处理快照数据（`.npz`）
- 生成点蚀随机场
- 图像数组统计（OCR 前空白图检测）

主要使用文件：
- `mg_coupled_pf/geometry.py`
- `mg_coupled_pf/io_utils.py`
- `scripts/train_surrogate.py`
- `scripts/ocr_formulas_pix2tex.py`

常用 API：
- `np.load`, `np.savez_compressed`
- `np.linspace`, `np.interp`, `np.cumsum`
- `np.asarray`, `arr.mean()`, `arr.std()`

## 3.2.1 ML 通道尺度化（本轮新增）
用途：
- 统一 surrogate / mechanics warmstart 的输入输出量纲；
- 避免 `phi/c/eta` 与 `ux/uy/epsp*` 数量级差异导致网络训练偏置；
- 确保“训练时尺度”与“部署推理尺度”一致。

主要使用文件：
- `mg_coupled_pf/ml/scaling.py`
- `mg_coupled_pf/ml/surrogate.py`
- `mg_coupled_pf/ml/mech_warmstart.py`
- `scripts/train_surrogate.py`
- `scripts/train_mechanics_warmstart.py`

关键函数：
- `build_surrogate_field_scales(cfg)`：构造 surrogate 通道尺度字典
- `build_mechanics_field_scales(cfg)`：构造 warmstart 输入/输出尺度
- `sanitize_field_scales(...)`：尺度合法化（缺省=1）

与配置的关系：
- `ml.enable_field_scaling=true` 时开启自动尺度化；
- surrogate checkpoint 保存 `field_scales`；
- warmstart checkpoint 保存 `input_scales/output_scales`。

## 3.2.2 晶体学转换与系统校验（本轮新增）
用途：
- 统一 HCP 系统定义（`s_crystal/n_crystal` 或 `direction_mb/plane_mb`）；
- 将晶体学系统通过欧拉角旋转到样品坐标；
- 对 `(s,n)` 做正交化，保证 `s·n≈0`，避免伪体积应变。

主要使用文件：
- `mg_coupled_pf/crystallography.py`
- `mg_coupled_pf/config.py`
- `mg_coupled_pf/mechanics.py`
- `mg_coupled_pf/crystal_plasticity.py`

关键接口：
- `resolve_system_pair_crystal(...)`
- `resolve_twin_pair_xy(...)`
- `bunge_euler_matrix(...)`
- `axis_angle_matrix(...)`

## 3.3 pyyaml
用途：
- 从 YAML 配置加载多物理参数

主要使用文件：
- `mg_coupled_pf/config.py`

常用 API：
- `yaml.safe_load(...)`

实践建议：
- 始终使用 `safe_load`，避免执行不受信任对象构造。

## 3.4 matplotlib
用途：
- 输出中间场、终态云图、网格图

主要使用文件：
- `mg_coupled_pf/io_utils.py`

常用 API：
- `plt.subplots`, `ax.imshow`, `ax.pcolormesh`
- `fig.colorbar`, `fig.savefig`
- 色图与坐标风格：`LinearSegmentedColormap`, `AutoMinorLocator`

注意事项：
- 超大网格下 SVG 体积巨大，代码已仅对关键图保存 SVG 以控制体积。

## 3.5 pytest
用途：
- 烟测、稳定性测试、架构可用性测试

主要使用文件：
- `tests/test_smoke.py`
- `tests/test_numerical_stability.py`
- `tests/test_surrogate_arches.py`

常用命令：
```powershell
.\.venv_gpu\Scripts\python.exe -m pytest -q
```

## 3.6 Pillow（PIL）
用途：
- 打开公式图片、检测空白、裁剪与保存

主要使用文件：
- `scripts/export_mathtype_images.py`
- `scripts/ocr_formulas_pix2tex.py`

常用 API：
- `Image.open(...)`
- `img.crop(...)`
- `img.save(...)`
- `img.convert("L")`

## 3.7 pywin32（win32com）
用途：
- 调用 Office COM 接口导出 Word/PPT 公式图

主要使用文件：
- `scripts/export_mathtype_images.py`

## 4. 本轮新增核心模块用法补充（2026-02-14）

### 4.1 三维晶体学滑移系 JSON

新增文件：`configs/slip_systems_hcp_3d.json`

字段说明：
- `name`: 滑移系名称
- `family`: `basal|prismatic|pyramidal`
- `s_crystal`: 晶体系滑移方向三维向量
- `n_crystal`: 晶体系滑移面法向三维向量

读取入口：
- `mg_coupled_pf/config.py::_load_slip_systems`
- `mg_coupled_pf/crystal_plasticity.py::CrystalPlasticityModel.__init__`

### 4.2 力学各向异性 HCP 弹性

实现文件：`mg_coupled_pf/mechanics.py`

实现要点：
- 基于 `C11/C12/C13/C33/C44` 构造四阶刚度；
- 通过 Bunge ZXZ 欧拉角进行取向旋转；
- 支持孪晶重取向后的刚度与母相刚度按 `h(eta)` 平滑混合。

## 5. 跨尺度机器学习与反向设计（新增）

### 5.1 模块结构

- `mg_coupled_pf/multiscale/features.py`
  - `extract_micro_tensor(...)`：从快照提取多通道微结构张量
  - `extract_micro_descriptors(...)`：提取可解释描述符（界面密度、穿透比、孪晶分数等）
- `mg_coupled_pf/multiscale/dataset.py`
  - `build_multiscale_dataset_from_cases(...)`：构建 `micro(t)->macro(t+ΔT)` 样本
- `mg_coupled_pf/multiscale/models.py`
  - `MacroCorrosionPredictor`：场编码 + 描述符融合 + 宏观目标回归
- `mg_coupled_pf/multiscale/train.py`
  - `train_multiscale_model(...)`：训练与验证
- `mg_coupled_pf/multiscale/inverse_design.py`
  - `run_inverse_design(...)`：基于 surrogate 的 CEM 搜索

### 5.2 命令流程

1. 构建跨尺度数据集

```powershell
python scripts/build_multiscale_dataset.py `
  --cases-root artifacts/sim_notch `
  --pattern * `
  --horizon-steps 4 `
  --target-h 96 --target-w 96 `
  --output artifacts/ml/multiscale_dataset.npz
```

2. 训练跨尺度模型

```powershell
python scripts/train_multiscale_macro.py `
  --dataset artifacts/ml/multiscale_dataset.npz `
  --output-model artifacts/ml/multiscale_macro.pt `
  --output-report artifacts/reports/multiscale_train_report.json `
  --device cuda `
  --epochs 120 --batch-size 16 --lr 2e-4
```

3. 预测单个快照的宏观指标

```powershell
python scripts/predict_multiscale_macro.py `
  --model artifacts/ml/multiscale_macro.pt `
  --snapshot artifacts/sim_notch/mg_notch_2d/snapshots/snapshot_001600.npz `
  --output artifacts/reports/multiscale_predict_1600.json
```

4. 反向设计搜索

```powershell
python scripts/inverse_design_multiscale.py `
  --config configs/notch_case.yaml `
  --model artifacts/ml/multiscale_macro.pt `
  --var domain.notch_depth_um:30:90:60 `
  --var domain.notch_half_opening_um:20:70:40 `
  --var corrosion.pitting_alpha:0.1:0.8:0.4 `
  --weight corrosion_loss:-1.0 `
  --weight penetration_x_ratio:-1.0 `
  --weight twin_fraction:0.1 `
  --iterations 30 --population 64 `
  --output artifacts/reports/inverse_design_multiscale.json
```

相关配置：
- `mechanics.use_anisotropic_hcp`
- `mechanics.anisotropic_blend_with_twin`
- `mechanics.crystal_orientation_euler_deg`
- `mechanics.twin_reorientation_axis`
- `mechanics.twin_reorientation_angle_deg`

### 4.3 surrogate 连续固相约束

实现文件：`mg_coupled_pf/ml/surrogate.py`

变更点：
- 从硬阈值掩膜改为 `h(phi)` 连续门控；
- 降低界面处的状态跳变，提高与相场连续界面假设的一致性。

### 4.4 surrogate 塑性场更新策略（新增）

相关配置（`mg_coupled_pf/config.py::MLConfig`）：
- `surrogate_update_mechanics_fields`
- `surrogate_update_plastic_fields`
- `surrogate_sync_cp_state_on_accept`

推荐设置：
- `surrogate_update_mechanics_fields: true`
- `surrogate_update_plastic_fields: false`

说明：
- 默认不让 surrogate 直接更新 `epsp_xx/epsp_yy/epsp_xy/epspeq`，由物理 CP 路径维护塑性历史闭合；
- 若必须开启塑性场 surrogate 更新，则在 accept 后会同步推进 `cp_state.g/gamma_accum`。

常用对象：
- `win32com.client.Dispatch("Word.Application")`
- `win32com.client.Dispatch("PowerPoint.Application")`

注意事项：
- 仅 Windows 可用，且需本机安装对应 Office。

## 3.8 pix2tex
用途：
- 将公式图片 OCR 为 LaTeX

主要使用文件：
- `scripts/ocr_formulas_pix2tex.py`

常用 API：
- `LatexOCR()`
- `pred = model(image)`

注意事项：
- 首次运行可能下载模型权重，需网络环境。

## 3.9 requests + beautifulsoup4
用途：
- 网页抓取与 HTML 解析（工具脚本）

主要使用文件：
- `tools/standalone/caoliu_scraper.py`

常用 API：
- `requests.Session().get(...)`
- `BeautifulSoup(html, "html.parser")`
- `soup.select(...)`

## 3.10 tqdm
用途：
- 进度可视化

主要使用文件：
- `tools/standalone/zip.py`
- `tools/standalone/caoliu_scraper.py`

常用 API：
- `for item in tqdm(iterable): ...`

## 3.11 pycryptodome（AES）
用途：
- 抓取脚本中的可选 AES 解密流程

主要使用文件：
- `tools/standalone/caoliu_scraper.py`

常用 API：
- `from Crypto.Cipher import AES`

## 4. 各脚本与依赖关系速查

### 4.1 核心仿真
- `scripts/run_notched_case.py`
  - 依赖：`torch, numpy, pyyaml, matplotlib`（通过核心包间接）
- `scripts/run_formal_comparison.py`
  - 依赖：同上 + 报告输出
- `scripts/benchmark_solver.py`
  - 依赖：`torch`
- `scripts/calibrate_fast_dt.py`
  - 依赖：`torch`

### 4.2 机器学习
- `scripts/train_surrogate.py`
  - 依赖：`torch, numpy`
- `scripts/benchmark_surrogate_models.py`
  - 依赖：`torch`

### 4.3 公式提取/OCR（可选）
- `scripts/export_mathtype_images.py`
  - 依赖：`pywin32, Pillow`
- `scripts/ocr_formulas_pix2tex.py`
  - 依赖：`pix2tex, Pillow, numpy`

### 4.4 其他工具
- `tools/standalone/caoliu_scraper.py`
  - 依赖：`requests, beautifulsoup4, tqdm, pycryptodome(可选)`
- `tools/standalone/zip.py`
  - 依赖：`tqdm`

## 5. 环境安装建议

## 5.1 核心仿真最小环境
```powershell
.\scripts\setup_env.ps1
```
或手动：
```powershell
python -m venv .venv_gpu
.\.venv_gpu\Scripts\activate
pip install -r requirements_sim.txt
```

## 5.2 可选工具扩展安装
```powershell
pip install pillow pywin32 pix2tex requests beautifulsoup4 tqdm pycryptodome
```

## 6. 常见问题与排查

### 6.1 GPU 可用但未加速
排查顺序：
1. `torch.cuda.is_available()` 是否为 `True`
2. 命令是否指定 `--device cuda`
3. 是否开启 `--mixed-precision`
4. 是否落入 CPU 回退环境（比如错误解释器）

### 6.2 公式导出失败
- 检查是否安装 Office
- 检查 `pywin32` 是否安装在当前解释器
- 检查 DOCX/PPTX 路径与文件权限

### 6.3 OCR 结果为空
- 先看 manifest 对应图片是否为空白
- 确认 pix2tex 模型已正确加载
- 可降低一次处理数量（`--limit`）分批排查

### 6.4 进度有输出但无图像
- 检查运行配置中：
  - `render_intermediate_fields`
  - `render_final_clouds`
  - `render_grid_figure`
- 或使用命令行强制打开：
  - `--render-intermediate-fields --render-final-clouds --render-grid-figure`

## 7. 开发建议
- 核心计算逻辑优先保持数值稳定，再做加速优化。
- 新增依赖前，先确认是否可在现有依赖中实现。
- 对可选工具依赖（如 Office COM、pix2tex）建议与核心仿真环境解耦。

## 8. 版本维护建议
- 每次升级 `torch/numpy` 后，至少执行一次：
  - `pytest`
  - 一次短程仿真
  - 一次 formal 对照
- 若库升级导致 API 行为变化，在本文件中追加“兼容性说明”小节。

## 9. 第二轮高级跨尺度扩展（U-AFNO + 多保真）

### 9.1 新增核心模块

- `mg_coupled_pf/multiscale/advanced_models.py`
  - `HybridUAFNOMacroPredictor`
  - `MultiFidelityHybridPredictor`
  - 高频/低频混合频域块 `SpectralConv2d + AFNOResidualBlock`
- `mg_coupled_pf/multiscale/advanced_train.py`
  - 多保真训练器（低保真主任务 + 高保真校正任务）
  - 物理边界软约束损失
- `mg_coupled_pf/multiscale/physics_metrics.py`
  - `Physics Consistency Index (PCI)`
  - 越界率、时序单调性、不确定性覆盖率
- `mg_coupled_pf/multiscale/visualization.py`
  - 训练曲线、parity 图、不确定性校准图
- `mg_coupled_pf/multiscale/data_generation.py`
  - 基于物理仿真的参数扫描与自动数据生产

### 9.2 新增脚本

- `scripts/generate_physics_multiscale_cases.py`
- `scripts/build_multifidelity_dataset.py`
- `scripts/train_multiscale_advanced.py`
- `scripts/evaluate_multiscale_advanced.py`
- `scripts/export_phasefield_theory_params.py`

### 9.3 推荐流程（无实验数据）

1. 生成物理仿真数据：

```powershell
python scripts/generate_physics_multiscale_cases.py `
  --config configs/notch_case.yaml `
  --var domain.notch_depth_um:40:90 `
  --var domain.notch_half_opening_um:20:60 `
  --var corrosion.pitting_alpha:0.2:1.2 `
  --n-cases 30 --n-steps 300 --save-every 30 `
  --output-root artifacts/sim_multiscale_dataset `
  --summary-json artifacts/reports/multiscale_generation_summary.json
```

2. 构建多保真训练集：

```powershell
python scripts/build_multifidelity_dataset.py `
  --cases-root artifacts/sim_multiscale_dataset `
  --pattern ms_case_* `
  --horizon-steps 1 --frame-stride 2 `
  --target-h 128 --target-w 128 `
  --low-target-h 48 --low-target-w 48 `
  --high-fidelity-ratio 0.3 `
  --output artifacts/ml/multifidelity_dataset.npz
```

3. 训练高级模型：

```powershell
python scripts/train_multiscale_advanced.py `
  --dataset artifacts/ml/multifidelity_dataset.npz `
  --output-model artifacts/ml/multiscale_advanced.pt `
  --model-name multifidelity_uafno `
  --epochs 120 --batch-size 16 --lr 2e-4 `
  --device cuda `
  --output-report-json artifacts/reports/multiscale_advanced_report.json `
  --output-report-md artifacts/reports/multiscale_advanced_report.md `
  --fig-dir artifacts/reports/multiscale_advanced_figs
```

4. 评估模型：

```powershell
python scripts/evaluate_multiscale_advanced.py `
  --model artifacts/ml/multiscale_advanced.pt `
  --dataset artifacts/ml/multifidelity_dataset.npz `
  --output artifacts/reports/multiscale_advanced_eval.json
```

### 9.4 科学正确性指标（推荐主指标）

- `PCI (Physics Consistency Index)`：综合
  - 物理边界越界率
  - 同算例时序单调一致率
  - 2σ 不确定性覆盖率校准误差
- 当高精度宏观标签稀缺时，PCI 比单一 MAE 更能反映“可用性与可信度”。

### 9.5 参数总表自动同步

- 导出命令：

```powershell
python scripts/export_phasefield_theory_params.py --config configs/notch_case.yaml --output docs/相场理论与参数总表.md
```

- 文档文件：`docs/相场理论与参数总表.md`
- 作用：将理论方程和全部配置参数统一列出，后续改参数只需重跑导出脚本即可全局同步。

## 10. 主动学习与闭环设计模块

### 10.1 新增库接口

- `mg_coupled_pf/multiscale/active_learning.py`
  - `run_active_learning_loop(...)`
- `mg_coupled_pf/multiscale/closed_loop_design.py`
  - `run_closed_loop_design(...)`
- `mg_coupled_pf/multiscale/visualization.py`
  - `plot_active_learning_progress(...)`

### 10.2 对应脚本

- `scripts/run_active_learning_multiscale.py`
- `scripts/run_closed_loop_design.py`

### 10.3 典型输出

- `artifacts/reports/active_learning_stage2_report.json`
- `artifacts/reports/active_learning_stage2_progress.png`
- `artifacts/reports/closed_loop_stage3_report.json`
- `artifacts/reports/closed_loop_stage3_scores.png`

### 10.4 作用定位

- 主动学习：
  - 用 surrogate 不确定性与目标优先级选取“最值得补算”的参数点；
  - 每轮补充物理样本并重训，提升样本效率。
- 闭环设计：
  - surrogate 负责候选筛选；
  - physics verify 负责真实性校核；
  - 局部再优化负责进一步改进最终设计参数。
