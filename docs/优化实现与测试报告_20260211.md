# 镁合金耦合相场代码优化实现与测试报告（2026-02-11）

本报告对应你提出的优化清单，给出：

- 已完成的代码改造项（逐条对应）
- 关键测试与小规模算例结果
- 当前仍需继续优化的风险点
- 可复现实验命令

---

## 1. 代码改造总览（已落地）

### 1.1 非均匀网格差分升级为真正二阶

已修改文件：

- `mg_coupled_pf/operators.py`

具体实现：

- 非均匀一阶导由简化中心差分替换为三点二阶局部格式（内点）+ 一侧二阶边界格式。
- 非均匀二阶导新增 `_second_deriv_x/_second_deriv_y`，`laplacian` 改为直接二阶导求和，不再走“先梯度再散度”。

效果（收敛比）：

- 梯度误差比（65 -> 129）：`3.95`（接近二阶理论 4）
- 拉普拉斯误差比（65 -> 129）：`3.79`

数据文件：

- `artifacts/reports/optimization_validation_metrics.json`

---

### 1.2 `phi/eta` 时间推进加入 IMEX

已修改文件：

- `mg_coupled_pf/config.py`
- `mg_coupled_pf/simulator.py`

具体实现：

- `phi`：线性界面项隐式（Helmholtz），非线性驱动显式。
- `eta`：变系数梯度项隐式（PCG 矩阵自由），其余驱动显式。
- 保留显式路径用于 A/B 对照：
  - `numerics.phi_integrator = explicit_euler | imex_helmholtz`
  - `numerics.eta_integrator = explicit_euler | imex_variable`

关键配置：

- `numerics.imex_solver_iters`
- `numerics.imex_solver_tol_abs`
- `numerics.imex_solver_tol_rel`
- `numerics.imex_relaxation`

小规模对照结果（CPU, 96x64, 50 步）：

- 显式 vs IMEX 终态误差：
  - `phi MAE = 8.01e-09`
  - `c MAE = 7.56e-11`
  - `eta MAE = 6.68e-13`
- 结论：小步长下两者数值一致性很好；IMEX 当前在该小算例的 wall-time 略高（隐式迭代额外成本），但可为更大步长稳定性提供空间。

---

### 1.3 力学求解器：新增 Krylov 路线并保留稳健回退

已修改文件：

- `mg_coupled_pf/config.py`
- `mg_coupled_pf/mechanics.py`
- `mg_coupled_pf/simulator.py`

具体实现：

- 新增矩阵自由 Krylov（BiCGStab + Jacobi 预条件）求解接口。
- 模式开关：
  - `numerics.mechanics_solver = relaxation | cg | hybrid_cg_relax`
- `hybrid_cg_relax`：Krylov 未收敛时自动回退到阻尼松弛，并熔断后续 Krylov 尝试，避免反复失败拖慢计算。
- 在 `sim.stats` 中新增：
  - `mech_cg_converged / mech_cg_failed / mech_cg_iters_sum`
  - `mech_ml_initial_guess_used`

当前测试观察（小算例）：

- `relaxation` 与 `hybrid_cg_relax` 终态一致（同峰值应力与平均 `phi`）。
- 当前参数下 Krylov 通道尚未在此工况收敛（发生一次失败后熔断），因此 hybrid wall-time 略高。
- 这保证了“正确性不退化”，但 Krylov 仍需后续继续调优（见第 6 节）。

---

### 1.4 晶体塑性：由方向向量插值改为 Schmid 张量混合

已修改文件：

- `mg_coupled_pf/crystal_plasticity.py`

具体实现：

- 去掉 `s/n` 向量线性插值 + 归一化。
- 预计算基体/孪晶两套 Schmid 张量分量 `(Pxx, Pyy, Pxy)`。
- 用 `eta` 的平滑权重对张量分量混合，再进行：
  - 分解剪应力计算
  - 塑性应变率回投

效果：

- 避免界面区域方向正交性被插值破坏。
- 与你反馈的“不要在界面产生非物理方向扭曲”一致。

---

### 1.5 ML 训练升级：监督 + 物理约束 + rollout

已修改文件：

- `scripts/train_surrogate.py`

新增能力：

- 训练目标从单一 `MSE` 升级为组合损失：
  - 监督项 `data`
  - 有界性/液相掩膜项 `bounds`
  - 平均浓度守恒近似项 `mass`
  - 力学平衡残差近似项 `mech`
  - 多步 rollout 项 `rollout`
- 新增 CLI 参数：
  - `--rollout-steps`
  - `--rollout-weight`
  - `--loss-data-weight`
  - `--loss-bounds-weight`
  - `--loss-mass-weight`
  - `--loss-mech-weight`
  - `--grad-clip`
- 训练日志输出每个子损失，便于定位漂移来源。

小规模训练烟测：

- 日志文件：`artifacts/reports/train_surrogate_physics_loss_smoke.log`
- 结果：脚本可稳定运行并输出分项损失。

---

### 1.6 surrogate gate 可解释性增强（拒绝原因统计）

已修改文件：

- `mg_coupled_pf/simulator.py`

新增统计：

- `ml_surrogate_attempt / accept / reject`
- 各拒绝原因计数（`ml_reject_phi_drop` 等）

烟测输出：

- `artifacts/reports/ml_gate_reason_stats_smoke.json`

---

## 2. 自动化测试结果

执行命令：

```powershell
.\.venv_gpu\Scripts\python -m pytest -q tests
```

结果：

- `11 passed`

覆盖点：

- 非均匀算子二阶趋势
- IMEX 小步一致性与大步有界性
- 力学 hybrid 回退稳定性
- 晶体塑性 Schmid 混合端点退化
- surrogate 架构构建/加载

---

## 3. 关键验证指标汇总

数据文件：

- `artifacts/reports/optimization_validation_metrics.json`

摘要：

1. 非均匀算子收敛性  
   - `grad ratio = 3.95`
   - `lap ratio = 3.79`

2. IMEX vs 显式（小步）  
   - `phi/c/eta` 终态 MAE 均接近机器误差级别

3. 力学模式对照  
   - `relaxation` 与 `hybrid_cg_relax` 终态一致（正确性保持）
   - 当前工况下 Krylov 分支未收敛并被熔断回退（稳健性优先）

---

## 4. 复现实验命令（本次报告同口径）

### 4.1 全部单元测试

```powershell
.\.venv_gpu\Scripts\python -m pytest -q tests
```

### 4.2 生成本报告用性能/精度指标

```powershell
@'
import json, time, math
from pathlib import Path
import torch
from mg_coupled_pf import CoupledSimulator, load_config
# 运行后写入 artifacts/reports/optimization_validation_metrics.json
'@ | .\.venv_gpu\Scripts\python -
```

### 4.3 物理约束训练烟测

```powershell
.\.venv_gpu\Scripts\python scripts/train_surrogate.py --config configs/notch_case.yaml --snapshots-dir artifacts/sim_notch/mg_half_half_tri_notch_highres_ml_afno_scaled/snapshots --epochs 1 --batch-size 2 --lr 1e-4 --device cpu --max-pairs 6 --rollout-steps 2 --rollout-weight 0.1 --loss-data-weight 1.0 --loss-bounds-weight 0.02 --loss-mass-weight 0.02 --loss-mech-weight 0.01
```

### 4.4 gate 拒绝原因统计烟测

```powershell
@'
import json
from pathlib import Path
from mg_coupled_pf import CoupledSimulator, load_config
# 运行后写入 artifacts/reports/ml_gate_reason_stats_smoke.json
'@ | .\.venv_gpu\Scripts\python -
```

---

## 5. 与你反馈项的对应结论

1. 非均匀差分精度问题：已修复为二阶局部格式，且通过收敛比验证。  
2. `phi/eta` 显式推进：已实现 IMEX 可切换路径。  
3. 力学求解升级：已加入 Krylov 路线 + hybrid 回退，保证不破坏正确性。  
4. 晶体塑性插值物理性：已切换为 Schmid 张量混合。  
5. ML 更“科学计算化”：训练端已加入物理约束项与 rollout 损失；推理端 gate 增加可解释统计。  

---

## 6. 仍需继续优化（下一步优先级）

1. **Krylov 分支收敛性调优（最高优先级）**  
   当前 small-case 下未收敛，hybrid 通过回退保证正确性，但未体现出速度优势。  
   建议下一步做：
   - 更严格的边界条件线性化处理；
   - 改进预条件器（块对角/近似 Schur）；
   - 在固定 `phi/eta/epsp` 下导出线性算子谱特性做参数整定。  

2. **IMEX 大步长收益评估**  
   已具备稳定化框架，下一步应系统扫描 `dt` 上限与误差曲线，给出“速度-精度” Pareto 曲线。  

3. **PINO/PDE residual 的高分辨率一致性训练**  
   目前训练端物理项为低成本近似，可继续升级为与主算子一致的残差离散以提高外推可信度。  

