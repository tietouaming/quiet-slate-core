# 本轮模型一致性修正报告（20260213_235423）

## 1. 已完成的关键修正

1) 核心路径去硬阈值投影
- 主求解链路不再使用 `solid_indicator(phi)` 做硬切相。
- 统一使用 `h(phi)` 连续权重约束 `eta/epsp/epspeq` 与液相抑制。

2) `eta` 语义统一
- 明确：`eta` 是序参量，`f_twin=h(eta)` 是孪晶体积分数。
- 门控与不确定性评估中的 `eta` 差异改为基于 `f_twin`。
- 诊断 `avg_eta` 改为 `mean(h(eta))`。

3) PDE residual gate 无量纲化
- `pde_phi/pde_c/pde_eta/pde_mech` 均改为无量纲残差。
- 解决了跨方程量纲混用导致的阈值不可比问题。

4) c 方程与化学自由能一致
- 默认启用 `concentration_use_mu_form=true`。
- 使用 `mu=A*(c-h(phi)Δc-c_l)` 与 `c_t=div(M∇mu)`，其中 `M=D/A`。

5) 界面厚度来源统一
- `corrosion.interface_thickness_um<=0` 时继承 `domain.interface_width_um`。
- `_omega_kappa_phi` 与几何初值使用同一来源。

6) pit 种子参数语义修正
- 新增 `initial_pit_sigma_um`（推荐使用）。
- 旧 `initial_pit_radius_um` 保留兼容并转换为 `sigma=radius/sqrt(2)`。

7) 腐蚀迁移率 L0 单位明确
- 新增 `L0_unit`，支持 `1_over_MPa_s` 与 `1_over_Pa_s` 自动换算。

8) CP 最小强度学耦合补齐
- 新增相依赖强度参数：`matrix/twin_crss_scale`, `matrix/twin_hardening_scale`。
- `CrystalPlasticityModel.update()` 中 `g_eff` 与 `dg` 均受 `h(eta)` 混合控制。

## 2. 测试结果

- `python -m pytest tests/test_numerical_stability.py -q` -> `26 passed`
- `python -m pytest -q` -> `38 passed`

新增/更新测试覆盖：
- `test_diffusion_rhs_mu_form_matches_explicit_mu_divergence`
- `test_mechanics_stress_divergence_uses_traction_free_on_neumann_boundaries`
- `test_cp_phase_dependent_strength_affects_plastic_rate`
- `test_phi_residual_uses_allen_cahn_l_times_laplacian_form`（适配无量纲残差）

## 3. 当前仍需进一步升级（下一阶段）

1) 3D 晶体学滑移/孪晶系（Miller–Bravais + 取向旋转）
- 本轮仅补了“最小强度学耦合”，尚未实现完整 3D 晶体学变体集合与取向张量映射。

2) Mg 各向异性弹性
- 目前力学仍是等效各向同性（`lambda, mu`）。
- 若目标是定量预测，需接入 HCP 各向异性刚度与取向旋转。

3) 学习型预条件器
- 当前已具备 warmstart 与门控基础，下一阶段建议将 ML 重点转到 Krylov 预条件器而非全场一步预测。
