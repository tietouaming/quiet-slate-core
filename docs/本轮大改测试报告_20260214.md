# 本轮大改与测试报告（2026-02-14）

## 1. 执行摘要
本轮完成了“晶体塑性-力学-代理模型”三处核心改造，并完成全量回归测试。

- 晶体塑性：支持 3D 晶体学滑移系（`s_crystal/n_crystal`）与 Bunge 欧拉角取向、孪晶轴角重取向。
- 力学本构：新增可选 HCP 各向异性弹性，支持母相/孪晶刚度按 `h(eta)` 混合。
- surrogate：固相约束由硬阈值掩膜改为连续 `h(phi)` 门控。
- 调用链：`constitutive_stress` 全链路传入 `eta`，避免耦合变量丢失。

## 2. 关键代码变更

### 2.1 配置与滑移系
- `mg_coupled_pf/config.py`
  - 新增取向与重取向配置项（CP/力学）。
  - 默认滑移系路径改为 `configs/slip_systems_hcp_3d.json`。
  - `mechanics.use_anisotropic_hcp` 默认保持 `false`（兼容旧工况），可显式开启。
- `configs/slip_systems_hcp_3d.json`
  - 新增 12 组 3D HCP 滑移系（basal/prismatic/pyramidal）。

### 2.2 晶体塑性模块
- `mg_coupled_pf/crystal_plasticity.py`
  - 兼容旧二维角度滑移系与新三维晶体学滑移系。
  - 引入 Bunge ZXZ 与轴角重取向，构造母相/孪晶两套 Schmid 张量。

### 2.3 力学模块
- `mg_coupled_pf/mechanics.py`
  - 新增 HCP 四阶刚度构造与旋转。
  - `constitutive_stress` 新增 `eta` 参数；可选使用各向异性本构并进行母相/孪晶混合。
  - Krylov 预条件的刚度参考值改为各向异性系数上界。

### 2.4 surrogate 与求解器接口
- `mg_coupled_pf/ml/surrogate.py`
  - 将 `phi>=0.5` 硬掩膜替换为 `h(phi)` 连续门控。
- `mg_coupled_pf/simulator.py`
  - 快速力学估计路径传递 `eta` 给本构，保持接口一致。

### 2.5 测试增强
- `tests/test_numerical_stability.py`
  - 新增各向异性力学有限性测试。
  - 新增孪晶刚度混合有效性测试。

## 3. 测试结果

执行命令：

```powershell
python -m pytest -q
```

结果：

- `40 passed`
- 无失败用例。

## 4. 文档润色更新
- `docs/中文操作手册.md`：新增“本轮大改、备份与同步”章节。
- `docs/改进分析与执行记录.md`：新增本次改造与测试记录。
- `docs/库与用法详解.md`：补充 3D 滑移系与各向异性力学用法说明。

## 5. 说明
- 当前默认配置仍以稳健兼容为主（各向异性默认关闭）；若用于高保真 Mg 晶体力学分析，建议在算例配置中显式开启 `mechanics.use_anisotropic_hcp: true` 并标定取向参数。
