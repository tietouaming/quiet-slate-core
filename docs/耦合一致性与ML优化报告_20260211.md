# 镁合金耦合相场程序本轮优化报告（2026-02-11）

## 1. 本轮目标

围绕你指出的“先天不自洽点”，优先修复以下 5 类硬问题，再做可验证的 ML/数值优化：

1. η 更新使用旧 φ 的耦合顺序错误。  
2. 平面应变下 `sigma_h` 未计入 `sigma_zz`。  
3. φ 的 IMEX 把变系数 `L(x)` 近似成常系数。  
4. `include_twin_grad_term_in_phi_variation` 的量纲混用（m/um）。  
5. surrogate 门控评估与“接受后力学校正”不一致。  

并同步完成：

- surrogate 状态完备化（加入塑性张量通道）；  
- 训练端加入离散 PDE 残差损失（PINO 思路）；  
- 兼容历史快照与历史模型；  
- 回归测试与小规模算例验证。  

## 2. 代码级改动清单

## 2.1 物理耦合自洽修复

- 文件：`mg_coupled_pf/simulator.py`  
- 变更：
  - 孪晶 TDGL 使用 `phi_new` 计算 `h(phi)`，不再使用旧 `phi`。
  - φ-IMEX 从 `mean(L_phi)` Helmholtz 改为变系数隐式：
    - `(I - dt*div(kappa*L_phi*grad)) phi_new = rhs`
  - φ PDE 残差评估同步改为 `+L*nonlin-div(kappa*L*grad(phi))` 一致形式。
  - `include_twin_grad_term_in_phi_variation` 下，η 梯度统一使用 `um` 尺度。

## 2.2 力学应力定义修复

- 文件：`mg_coupled_pf/mechanics.py`  
- 变更：
  - `constitutive_stress()` 在 `plane_strain=True` 时计算 `sigma_zz=lambda*(eps_xx+eps_yy)`。
  - `sigma_h=(sigma_xx+sigma_yy+sigma_zz)/3`。

## 2.3 surrogate 状态完备化与一致门控

- 文件：`mg_coupled_pf/geometry.py`、`mg_coupled_pf/ml/surrogate.py`、`mg_coupled_pf/simulator.py`  
- 变更：
  - 初始状态新增 `epsp_xx/epsp_yy/epsp_xy`。
  - `FIELD_ORDER` 扩展为 9 通道：
    - `phi,c,eta,ux,uy,epspeq,epsp_xx,epsp_yy,epsp_xy`
  - simulator 内部 `self.epsp` 与 `state` 双向同步。
  - surrogate 门控新增塑性张量液相掩膜检查与增量阈值检查。
  - `enable_surrogate_mechanics_correction=True` 时，门控阶段先做同一套力学校正再判定，避免门控与执行系统不一致。
  - `load_surrogate()` 改为按形状过滤加载，兼容旧 checkpoint。

## 2.4 训练端物理损失升级

- 文件：`scripts/train_surrogate.py`  
- 变更：
  - 新增参数 `--loss-pde-weight`。
  - `_physics_losses()` 新增 `phi/c/eta` 离散 PDE 残差损失 `pde_loss`。
  - 力学残差从 `epspeq` 简化项升级为 `epsp_xx/yy/xy` 张量参与。
  - 快照加载兼容旧格式：缺失 `epsp_xx/yy/xy` 时自动零填充。

## 3. 测试与验证

## 3.1 自动化测试

- 命令：`python -m pytest -q`  
- 结果：`18 passed`

新增测试：

1. `tests/test_numerical_stability.py::test_plane_strain_sigma_h_includes_sigma_zz`  
2. `tests/test_surrogate_arches.py::test_predict_compatible_with_legacy_state_without_epsp_tensor_channels`  
3. `tests/test_train_surrogate_loader.py::test_snapshot_loader_fills_missing_epsp_channels`  

## 3.2 小规模算例回归

- 单算例回归命令：

```powershell
python scripts/run_notched_case.py --config configs/notch_case.yaml --device cpu --disable-ml --dt-s 1e-4 --total-time-s 5e-4 --save-interval-s 5e-4 --progress --progress-every 1 --no-render-intermediate-fields --render-final-clouds --render-grid-figure
```

- 结果：
  - `final_clouds`、`grid`、`history` 均正常输出。
  - 输出目录：`artifacts/sim_notch/mg_notch_2d`

- 物理/ML对照回归命令：

```powershell
python scripts/run_formal_comparison.py --config configs/notch_case.yaml --steps 6 --save-every 6 --device cpu --progress-every 3 --case-tag quick_regress --report-json artifacts/reports/quick_regress_report.json --report-md artifacts/reports/quick_regress_report.md
```

- 结果摘要（来自 `artifacts/reports/quick_regress_report.json`）：
  - `final_solid_fraction_abs_diff = 0.0`
  - `phi/c/eta` 终场误差均为 `0.0`
  - `epspeq` 终场 `max_abs ≈ 1.65e-09`

## 4. 论文对齐说明（本轮采用）

1. PINO（训练中引入 PDE 约束）：https://arxiv.org/abs/2111.03794  
2. FNO（神经算子基线）：https://arxiv.org/abs/2010.08895  
3. AFNO（高效频域算子）：https://arxiv.org/abs/2111.13587  
4. SAV（能量稳定时间推进）：https://www.math.purdue.edu/~shen7/pub/SXY17.pdf  
5. Learning Preconditioners for CG：https://proceedings.mlr.press/v202/li23e.html  
6. Convex Splitting：https://epubs.siam.org/doi/10.1137/080738143  

## 5. 当前结论与下一步建议

本轮已把你指出的核心“逻辑不自洽”问题全部修到代码路径中，并通过回归测试确认无功能破坏。  
下一步若继续冲“同精度下更高加速比”，建议按以下顺序推进：

1. 力学 Krylov 路径做“学习初值/学习预条件器”专项（优先级最高）。  
2. φ/η 时间推进进一步引入 SAV/凸分裂能量稳定格式。  
3. surrogate 训练加入不确定性头（方差输出）并与门控联动。  
