# 镁合金耦合相场程序：机器学习与加速原理详解

## 1. 文档目的

本文档说明当前程序中机器学习模块的完整技术路线、训练与推理细节、加速机制、正确性约束，以及“更前沿模型”的引入方式与实测效果。

## 2. 机器学习总体思路

### 2.1 目标

在不破坏物理正确性的前提下，用 surrogate 模型替代部分物理步，降低每单位物理时间的墙钟耗时。

### 2.2 学习对象

模型学习的是“状态增量（残差）”而不是绝对场值：

- 输入状态：`[phi, cMg, eta, ux, uy, epspeq]`
- 预测残差：`delta_state`
- 推理更新：`state_{t+1} = state_t + delta_state`

这种残差学习通常比直接回归绝对场更稳定，也更容易和物理校正联动。

## 3. 训练数据与标签构造

### 3.1 数据来源

来自纯物理求解快照：`snapshots/snapshot_XXXXXX.npz`

### 3.2 标签定义

对相邻快照 `(a, b)`：

- `x = state(a)`
- `dy = (state(b) - state(a)) / gap`
- 其中 `gap = step_b - step_a`

即按步距归一化增量，兼容非 1 步间隔快照。

### 3.3 训练实现

文件：`scripts/train_surrogate.py`

- 损失函数：`MSE(pred_delta, true_delta)`
- 优化器：`Adam`
- 支持 `AMP` 混合精度
- 支持 `--streaming` 流式读取，避免高分辨率快照爆内存

## 4. 在线推理策略（Predictor-Corrector）

文件：`mg_coupled_pf/simulator.py`

### 4.1 主流程

1. 按 `rollout_every` 周期尝试 surrogate 预测  
2. 通过门控检查后接受；否则退回物理步  
3. 可设置 `anchor_physics_every` 周期强制物理锚定  
4. 连续拒绝达到阈值后，暂停或禁用 surrogate

### 4.2 物理约束门控

接受 surrogate 之前检查：

- 全局均值增量阈值（`phi/c/eta/epspeq`）
- 全场最大增量阈值（`max_field_delta`）
- 组合残差门槛（`residual_gate`）
- 液相约束：液相中的 `eta/epspeq` 不能超阈值

### 4.3 推理后物理裁剪

在 surrogate 输出后强制：

- `phi, cMg, eta` 限制到物理区间
- `eta` 和 `epspeq` 仅保留在固相（液相置零）

## 5. 模型架构：当前与新增

文件：`mg_coupled_pf/ml/surrogate.py`

### 5.1 基线模型：TinyUNet

- 局部卷积 + 下采样/上采样结构
- 参数量低，推理快，工程稳定性好

### 5.2 新增前沿模型：FNO2D（Fourier Neural Operator）

新增可选架构：`model_arch: fno2d`

核心组成：

- 频域谱卷积（`SpectralConv2d`）
- 点卷积旁路
- 多层 FNO block 残差堆叠
- 坐标通道注入（`x,y`）

优势：

- 擅长学习 PDE/算子级映射，感受野全局
- 在同等误差目标下，有机会减少锚定频率并提高 surrogate 接受率

### 5.3 新增前沿模型：AFNO2D-Lite（Adaptive Fourier Neural Operator）

新增可选架构：`model_arch: afno2d`

核心组成：

- 频域 token mixing（低频截断 + 频域 MLP）
- 局部 1x1 旁路分支
- 轻量深度堆叠（适配大分辨率）

优势：

- 保持全局频域建模能力，同时参数量显著降低
- 在本项目的 512x1024 surrogate 基准中，已出现比 TinyUNet 更快的推理组合

### 5.4 新增轻量模型：DW-UNet（Depthwise Separable UNet）

新增可选架构：`model_arch: dw_unet`

定位：

- 深度可分离卷积，参数更少，适合作为移动端/极限显存备选。
- 在当前 GPU 上未必最快，但保留为可复现实验分支。

## 6. 加速原理（非 ML + ML）

### 6.1 非 ML 核心加速

1. 扩散 STS 超时间步  
文件：`mg_coupled_pf/simulator.py`  
在大 `dt` 下替代大量显式子步，显著降耗。

2. 力学自适应收敛  
文件：`mg_coupled_pf/mechanics.py`  
残差达标后提前停止迭代，减少无效子步。

3. GPU 路径  
`CUDA + AMP + channels_last + 可选 torch.compile`

4. 自动安全快步长校准  
文件：`scripts/calibrate_fast_dt.py`  
在误差阈值约束下自动选最快 `dt`。

### 6.2 ML 相关加速

ML 加速 = surrogate 步替代物理步带来的节省，受两点制约：

1. surrogate 单步推理延迟
2. surrogate 可接受率（门控通过率）

因此“更先进模型”不等于“单步更快”，但可能在更高接受率下实现总体更快。

## 7. 新增模型的实测基准（当前机器）

脚本：`scripts/benchmark_surrogate_models.py`  
本轮结果文件：`artifacts/reports/surrogate_arch_benchmark_4models.json`

测试条件：

- GPU：RTX 3060 Laptop
- 输入尺寸：`1 x 6 x 512 x 1024`
- `channels_last + torch.compile`

实测（`512x1024`, RTX3060, batch=1）：

- TinyUNet（hidden=32）：`20.76 ms/step`
- DW-UNet（hidden=24, depth=2）：`69.63 ms/step`
- FNO2D（width=16,modes=12x8,depth=3）：`23.83 ms/step`
- AFNO2D（width=12,modes=8x6,depth=2,exp=1.25）：`12.96 ms/step`

结论：

- 当前基准下，`afno2d` 已成为最快 surrogate 推理架构（约为 TinyUNet 的 `1.60x`）。
- `fno2d` 与 `dw_unet` 已完整接入，分别用于“算子学习精度路线”和“轻量卷积路线”。
- 实际仿真总加速仍取决于 surrogate 接受率与门控设置，不仅是单步推理延迟。

## 8. 如何启用前沿模型

### 8.1 训练 AFNO surrogate（推荐前沿加速）

```powershell
.\.venv_gpu\Scripts\python scripts/train_surrogate.py --config configs/half_half_highres_fast_ml_afno.yaml --snapshots-dir artifacts/sim_notch/mg_half_half_tri_notch_highres_fast_physics/snapshots --epochs 25 --batch-size 2 --lr 5e-4 --device cuda --mixed-precision --streaming --model-arch afno2d --afno-width 12 --afno-modes-x 8 --afno-modes-y 6 --afno-depth 2 --afno-expansion 1.25
```

### 8.2 运行 AFNO 推理

```powershell
.\.venv_gpu\Scripts\python scripts/run_formal_comparison.py --config configs/half_half_highres_fast_ml_afno.yaml --dt-s 0.005 --total-time-s 0.5 --save-interval-s 0.5 --device cuda --mixed-precision --case-tag afno_eval
```

### 8.3 架构自动识别加载

模型保存时会写入 `meta.model_arch + arch_kwargs`，推理端 `load_surrogate()` 自动识别，避免手工匹配错误。

### 8.4 频域模型与混合精度说明

`fno2d/afno2d` 都使用复杂频域 FFT。考虑到 CUDA `ComplexHalf` 支持限制，训练脚本对这两类架构会自动关闭 AMP，以保证稳定性和正确性。

## 9. 正确性与精确性保障清单

1. 状态物理边界裁剪（`phi/c/eta/epspeq`）  
2. 液相-固相约束（液相 `eta/epspeq`）  
3. surrogate 门控拒绝 + 锚定回退  
4. 稳定性测试（`tests/test_numerical_stability.py`）  
5. STS 与显式子步一致性测试  
6. 正式对照报告（`scripts/run_formal_comparison.py`）

## 10. 下一步前沿方向（建议）

在不牺牲正确性的前提下，优先级建议：

1. 物理分块代理：只代理 `phi-cMg` 子系统，力学保持物理求解  
2. 不确定度门控：MC Dropout/ensemble，用不确定度触发回退  
3. 多步 rollout 训练：显式优化 5~20 步累计误差而非单步 MSE  
4. 轻量 AFNO/低秩谱算子：在保持全局感受野下进一步降延迟  
5. 蒸馏：以高精度 teacher（AFNO/FNO）蒸馏到快速 student（TinyUNet）

---

如需，我可以在下一轮直接实现“分块代理 + 不确定度门控”版本，这是当前最有希望在你这个算例里继续提速且不牺牲精度的路线。
