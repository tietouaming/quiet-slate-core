# 本轮优化与测试报告（20260213_170040）

## 一、你提出的关键问题与本轮落地结果

1. 门控能量与方程不一致（已修正）
- 变更：`_compute_free_energy(..., for_gate=True|False)` 支持 `E_gate/E_diag` 双轨。
- 默认：`ml.energy_gate_use_variational_core=true`，门控使用 `E_gate`。
- 配置默认修正：`corrosion.include_mech_term_in_free_energy=false`。

2. c 方程与化学自由能尺度不一致（已修正）
- 新增：`corrosion.concentration_use_mu_form=true`（默认）。
- 实现：`mu=A_mpa*(c-h(phi)*(cs-cl)-cl)`，`c_t=div(M*grad(mu))`，`M=D/A_mpa`。
- 保留旧写法兼容开关（可做 A/B 对照）。

3. 力学 Neumann 边界语义问题（已修正）
- 新增力学应力散度：`MechanicsModel.stress_divergence()`。
- 在 `mechanics_bc=neumann` 轴上按 traction-free (`sigma·n=0`) 处理边界面通量。
- 力学线性算子、右端项、松弛残差、门控残差统一切到该散度定义。

## 二、涉及文件

- `mg_coupled_pf/config.py`
- `mg_coupled_pf/simulator.py`
- `mg_coupled_pf/mechanics.py`
- `tests/test_numerical_stability.py`
- `docs/中文操作手册.md`
- `docs/改进分析与执行记录.md`
- `docs/theory_review_for_approval.md`

## 三、测试结果

### 1) 重点回归
- 命令：`python -m pytest tests/test_numerical_stability.py -q`
- 结果：`25 passed`

### 2) 全量测试
- 命令：`python -m pytest -q`
- 结果：`37 passed`

## 四、本轮新增/更新测试点

- `test_diffusion_rhs_mu_form_matches_explicit_mu_divergence`
- `test_mechanics_stress_divergence_uses_traction_free_on_neumann_boundaries`
- 更新 `test_energy_gate_auto_skips_when_nonvariational_mech_term_enabled`（适配新 gate 逻辑）

## 五、当前状态说明

- 代码已完成“门控一致性 + c 方程一致性 + 力学边界语义”三项核心修正。
- 下一阶段高收益加速建议：在现有 warmstart 基础上，引入“学习型预条件器”用于 Krylov 降迭代。
