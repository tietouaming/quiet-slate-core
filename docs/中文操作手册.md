# 镁合金耦合相场项目中文操作手册

本文覆盖本仓库常用的全部操作命令，包含公式提取、环境配置、仿真、训练、基准、回归检查与 GPU 性能模式。

## 1. 目录与约定

- 工作目录：`d:\zip_pojie`
- 主配置：
  - CPU/通用：`configs/notch_case.yaml`
  - GPU性能模式：`configs/notch_case_gpu.yaml`
- 主输出目录：`artifacts/sim_notch/`

## 2. 环境配置

### 2.1 一键创建 CPU 环境

```powershell
powershell -ExecutionPolicy Bypass -File scripts/setup_env.ps1 -VenvPath .venv_sim -TorchVariant cpu -Recreate
```

### 2.2 一键创建 GPU 环境（推荐）

```powershell
powershell -ExecutionPolicy Bypass -File scripts/setup_env.ps1 -VenvPath .venv_gpu -TorchVariant auto -Recreate
```

说明：
- `-TorchVariant auto` 会优先尝试 CUDA 版 PyTorch（`cu126`，失败则回退）。
- 脚本会打印 `torch_cuda` 与 `cuda_available`，用于确认是否成功切到 GPU。

### 2.3 手动确认 PyTorch 是否为 GPU 版

```powershell
.\.venv_gpu\Scripts\python -c "import torch; print(torch.__version__, torch.version.cuda, torch.cuda.is_available(), torch.cuda.device_count())"
```

## 3. 公式提取与 OCR（Word/PPT MathType）

### 3.1 导出 Word/PPT 中公式图片

```powershell
python scripts/export_mathtype_images.py --docx "data/raw_documents/镁单晶塑性变形行为的晶体塑性-孪晶耦合相场模拟.docx" --pptx "data/raw_documents/260113.pptx" --out-dir artifacts/formula_extract
```

### 3.2 运行 pix2tex OCR

```powershell
python scripts/ocr_formulas_pix2tex.py --manifest artifacts/formula_extract/formula_images_manifest.jsonl --out-jsonl artifacts/formula_extract/formulas_ocr.jsonl --out-md artifacts/formula_extract/formulas_ocr_preview.md
```

### 3.3 分批 OCR（大数据量建议）

```powershell
python scripts/ocr_formulas_pix2tex.py --limit 100
```

### 3.4 全量重跑 OCR（覆盖旧结果）

```powershell
python scripts/ocr_formulas_pix2tex.py --overwrite
```

## 4. 相场耦合仿真

### 4.1 纯物理求解（禁用 ML）

```powershell
python scripts/run_notched_case.py --config configs/notch_case.yaml --disable-ml
```

### 4.2 GPU 上运行纯物理（小规模试算）

```powershell
.\.venv_gpu\Scripts\python scripts/run_notched_case.py --config configs/notch_case.yaml --device cuda --dt-s 5e-5 --total-time-s 0.002 --save-interval-s 0.001 --disable-ml
```

### 4.2.1 高精度细网格算例（推荐复核）

```powershell
.\.venv_gpu\Scripts\python scripts/run_notched_case.py --config configs/notch_case_highres.yaml --progress --progress-every 20
```

说明：`configs/half_half_highres.yaml` 当前为 `1024x512`（`524,288` 网格），并启用缺口附近非均匀加密。
说明：该配置三角缺口尺寸为“宽 50 um、深 100 um”。

### 4.3 启用 ML predictor-corrector

```powershell
python scripts/run_notched_case.py --config configs/notch_case.yaml
```

### 4.4 常用运行参数

```powershell
python scripts/run_notched_case.py `
  --config configs/notch_case.yaml `
  --device cuda `
  --mixed-precision `
  --dt-s 5e-5 `
  --total-time-s 0.01 `
  --save-interval-s 0.001 `
  --progress `
  --progress-every 20 `
  --disable-torch-compile `
  --no-clean-output
```

参数说明：
- `--device`: `auto/cpu/cuda`
- `--mixed-precision`: CUDA 混合精度
- `--disable-torch-compile`: 关闭 `torch.compile`
- `--no-clean-output`: 不清理旧输出
- `--progress`: 输出可视化进度条与关键状态
- `--progress-every`: 进度输出间隔（内部仍按步触发，显示为物理时间）
- `--dt-s`: 物理时间步长（秒）
- `--total-time-s`: 总物理时长（秒）
- `--save-interval-s`: 输出时间间隔（秒）
- `--override-steps/--override-save-every`: 兼容旧参数，不建议作为首选
说明：程序内部已启用扩散自适应子步进（配置项 `numerics.diffusion_auto_substeps`），用于在细网格下保持 `cMg` 更新稳定。
说明：`phi/eta` 默认可走 IMEX 稳定格式（`numerics.phi_integrator`, `numerics.eta_integrator`）。
说明：力学支持 `relaxation/cg/hybrid_cg_relax`（`numerics.mechanics_solver`）。
说明：Krylov 默认使用 `gmres`（`numerics.mechanics_krylov_method`），并带失败冷却重试机制。

### 4.5 力学 Krylov 参数（专项调参后默认）

- `numerics.mechanics_krylov_method: gmres`
- `numerics.mechanics_gmres_restart: 24`
- `numerics.mechanics_gmres_max_restarts: 6`
- `numerics.mechanics_cg_max_iters: 120`
- `numerics.mechanics_cg_tol_abs: 5.0`
- `numerics.mechanics_cg_tol_rel: 0.005`
- `numerics.mechanics_krylov_fail_streak_to_pause: 3`
- `numerics.mechanics_krylov_pause_steps: 30`

专项报告见：`docs/力学Krylov收敛专项调参报告_20260211.md`

运行结束后会自动输出最终云图到：
- `artifacts/sim_notch/<case_name>/final_clouds/von_mises_cloud.png`
- `artifacts/sim_notch/<case_name>/final_clouds/eta_cloud.png`（对应你说的 `yeta`）
- `artifacts/sim_notch/<case_name>/final_clouds/yeta_cloud.png`
- `artifacts/sim_notch/<case_name>/final_clouds/cMg_cloud.png`
- `artifacts/sim_notch/<case_name>/final_clouds/phi_cloud.png`
- `artifacts/sim_notch/<case_name>/final_clouds/final_clouds_2x2.png`
矢量图（SVG）默认输出 `phi_cloud.svg`（用于界面细节检查）。
说明：云图标题标注物理时间 `t = ... s`，但不叠加网格线。
说明：云图色标统一为“高值红、低值蓝”。

裂纹/缺口尖端局部放大图输出到：
- `artifacts/sim_notch/<case_name>/final_clouds_tip_zoom/phi_tip_zoom.png`
- `artifacts/sim_notch/<case_name>/final_clouds_tip_zoom/cMg_tip_zoom.png`
- `artifacts/sim_notch/<case_name>/final_clouds_tip_zoom/yeta_tip_zoom.png`
- `artifacts/sim_notch/<case_name>/final_clouds_tip_zoom/von_mises_tip_zoom.png`
- `artifacts/sim_notch/<case_name>/final_clouds_tip_zoom/tip_zoom_2x2.png`
矢量图（SVG）默认输出 `phi_tip_zoom.svg`。
说明：默认放大窗口为 `12 um × 9 um`（以缺口尖端为中心）。

网格图单独输出到：
- `artifacts/sim_notch/<case_name>/grid/mesh_full.png`
- `artifacts/sim_notch/<case_name>/grid/mesh_notch_zoom.png`
说明：网格图与云图分目录保存，互不叠加。

## 5. Surrogate 训练

### 5.1 先生成高质量训练样本（建议 `save_every=1`）

```powershell
python scripts/run_notched_case.py --config configs/notch_case.yaml --disable-ml --dt-s 5e-5 --total-time-s 0.01 --save-interval-s 5e-5
```

### 5.2 训练 surrogate（GPU 版）

```powershell
.\.venv_gpu\Scripts\python scripts/train_surrogate.py --config configs/notch_case.yaml --device cuda --epochs 20 --batch-size 8 --mixed-precision --channels-last
```

带物理约束与 rollout 的训练示例：

```powershell
.\.venv_gpu\Scripts\python scripts/train_surrogate.py --config configs/notch_case.yaml --device cuda --epochs 20 --batch-size 8 --mixed-precision --channels-last --rollout-steps 2 --rollout-weight 0.1 --loss-data-weight 1.0 --loss-bounds-weight 0.02 --loss-mass-weight 0.02 --loss-mech-weight 0.01 --grad-clip 1.0
```

### 5.3 训练脚本常用参数

- `--device auto|cpu|cuda`
- `--mixed-precision`
- `--channels-last`
- `--disable-torch-compile`

## 6. 性能基准

### 6.1 CPU 或自动设备基准

```powershell
python scripts/benchmark_solver.py --config configs/notch_case.yaml --steps 200 --warmup-steps 20
```

### 6.2 GPU 基准

```powershell
.\.venv_gpu\Scripts\python scripts/benchmark_solver.py --config configs/notch_case.yaml --device cuda --steps 200 --warmup-steps 20
```

## 7. 全流程自动检查

### 7.1 CPU/通用

```powershell
python scripts/run_all_checks.py --config configs/notch_case.yaml
```

### 7.2 GPU 全流程检查（推荐）

```powershell
.\.venv_gpu\Scripts\python scripts/run_all_checks.py --config configs/notch_case.yaml --device cuda --physics-steps 80 --ml-steps 80 --bench-steps 80 --train-epochs 3 --train-batch-size 8 --max-solid-drift 0.1 --min-speedup 1.05
```

说明：`--min-speedup 1.05` 建议搭配 `bench-steps>=40`，步数过短时计时波动会放大。

## 8. 常见问题

### 8.1 `torch.cuda.is_available() = False`

建议顺序：
1. 先执行 `nvidia-smi` 确认驱动正常。
2. 用 `scripts/setup_env.ps1 -TorchVariant auto` 重建环境。
3. 若仍失败，改用 `-TorchVariant cu124` 或 `-TorchVariant cu121`。

### 8.2 Windows 下 `torch.compile`/Triton 报错

当前代码已自动规避无 Triton 场景；若仍遇到编译问题，可显式关闭：

```powershell
python scripts/run_notched_case.py --disable-torch-compile
```

### 8.3 输出目录被覆盖

默认会清理旧快照。若要保留历史结果：

```powershell
python scripts/run_notched_case.py --no-clean-output
```

## 9. 程序架构详解

### 9.1 分层架构

本程序采用“配置层 -> 数值核心层 -> 运行脚本层 -> 报告层”的结构：

1. 配置层：`mg_coupled_pf/config.py`  
   负责参数分组、YAML 合并、默认值和滑移系读取。
2. 数值核心层：`mg_coupled_pf/*.py`  
   包含网格/算子/力学/晶体塑性/耦合器/主求解器。
3. 运行脚本层：`scripts/*.py`  
   面向任务的入口（跑算例、训练 surrogate、benchmark、全流程检查）。
4. 报告层：`artifacts/**` + `docs/**`  
   统一输出 history、快照、图像和验收报告。

### 9.2 核心模块职责

- `mg_coupled_pf/simulator.py`  
  主时间推进器；每步执行“力学-晶塑 -> 腐蚀/扩散/孪晶 -> 状态清理 -> 记录”。
- `mg_coupled_pf/mechanics.py`  
  小变形准静态平衡求解，含残差阻尼、位移/应变限幅稳定化。
- `mg_coupled_pf/crystal_plasticity.py`  
  滑移系分解、分辨剪应力、过应力滑移律、潜硬化更新。
- `mg_coupled_pf/operators.py`  
  二维有限差分算子（梯度、散度、拉普拉斯、平滑 Heaviside）。
- `mg_coupled_pf/geometry.py`  
  微米级尖锐缺口几何、初始 pit 与空间随机点蚀场。
- `mg_coupled_pf/couplers.py`  
  扩展接口层（电场、氢脆）以插件方式注入，不破坏主方程框架。
- `mg_coupled_pf/ml/surrogate.py`  
  轻量 U-Net surrogate、状态张量打包/解包、推理门控配套。

### 9.3 单个物理时间增量求解流程（每个 `dt`）

1. 力学求解：根据当前 `phi/eta/epsp` 更新应力场。  
2. 晶体塑性更新：依据应力与孪晶状态更新滑移与硬化、`epspeq`。  
3. 腐蚀相场更新：Allen-Cahn 形式推进 `phi`，迁移率含机械放大。  
4. 溶质扩散更新：基于 `phi` 依赖扩散系数推进 `c`。  
5. 孪晶 TDGL 更新：推进 `eta`，包含缺口附近成核扰动。  
6. 状态清理：`nan_to_num` + 物理上下界裁剪，确保稳定。  
7. 记录输出：history、快照、图像（按 `save_every`）。

### 9.4 机器学习技术路线

采用 predictor-corrector 思路：

1. 用物理求解生成快照样本。  
2. surrogate 学习“每步残差”`delta_state`（已按快照步长归一化）。  
3. 在线推理时按 `rollout_every` 周期尝试 surrogate 步。  
4. 经门控校验（场增量、均值漂移、残差阈值）后才接受；否则退回物理步。  

这样可以在加速的同时降低累计漂移风险。

### 9.5 GPU 性能路线

当前已实现：

1. CUDA 设备选择与自动回退。  
2. mixed precision（autocast）路径。  
3. benchmark 的 warmup + CUDA 同步计时。  
4. surrogate 训练 channels-last 优化。  
5. `torch.compile` 可开关，并在 Windows+无 Triton 时自动禁用。  

### 9.6 可扩展接口路线（电场/氢脆）

通过 `couplers.py` 的统一接口注入：

- `corrosion_mobility_multiplier()`
- `concentration_drift_flux()`
- `update_material_overrides()`

未来扩展电化学场、氢扩散-脆化，只需在该接口下新增耦合器并在配置中开关。

### 9.7 参数结构与作用路径

配置文件按功能分层，建议按下列顺序调参：

1. `domain`：几何与网格规模  
   影响计算量和缺口分辨率（`nx, ny, lx_um, ly_um` 等）。
2. `numerics`：时间推进与求解策略  
   影响稳定性和速度（`dt_s, n_steps, mechanics_substeps`）。
3. `corrosion`：腐蚀相场与扩散参数  
   影响 `phi/c` 演化速度与界面形貌。
4. `twinning`：孪晶演化参数  
   影响 `eta` 的成核与扩展。
5. `crystal_plasticity`：滑移、硬化、CRSS  
   影响塑性应变速率与应力松弛路径。
6. `mechanics`：弹性参数与外载  
   影响应力分布与机械耦合强度。
7. `ml`：代理模型门控与 rollout  
   影响加速比与精度平衡。
8. `runtime`：设备、输出与清理策略  
   影响运行环境和结果管理。

### 9.8 模块交互与调用链

常规调用链：

1. `scripts/run_notched_case.py` 读取 YAML
2. `load_config()` 生成 `SimulationConfig`
3. `CoupledSimulator.__init__()` 构建网格、状态、子模型
4. `CoupledSimulator.run()` 进入时间循环
5. `step()` 内部执行 physics/surrogate 分支
6. `io_utils` 写出 `history.csv`、`snapshot_*.npz`、`fields_*.png`

训练调用链：

1. `scripts/train_surrogate.py` 读取 `snapshot_*.npz`
2. 将快照差分归一化为每步残差标签
3. 训练 `TinyUNet` 并保存到 `artifacts/ml/surrogate_latest.pt`
4. 后续仿真自动加载该模型用于 predictor-corrector

### 9.9 数据流与结果文件说明

单次算例典型输出：

- `history.csv`  
  每步标量历史（固相分数、最大静水应力、平均等效塑性应变等）。
- `snapshots/snapshot_XXXXXX.npz`  
  场变量快照（`phi,c,eta,ux,uy,epspeq` + `sigma_xx/yy/xy/h`）。
- `figures/fields_XXXXXX.png`  
  便于快速检查的可视化拼图。

正式对照报告输出：

- `artifacts/reports/formal_1600_report.json`：可机读
- `artifacts/reports/formal_1600_report.md`：可直接阅读

### 9.10 技术路线总结（从理论到工程）

1. 理论侧：腐蚀相场 + 晶体塑性 + 孪晶 + 力学耦合  
2. 数值侧：有限差分 + 分步耦合 + 稳定化钳制  
3. 工程侧：配置驱动 + 脚本自动化 + 报告化验收  
4. 加速侧：GPU + mixed precision + surrogate 门控替代  
5. 扩展侧：耦合器接口预留电场/氢脆通道

### 9.11 完整理论表达（与PPT一致的复核版）

以下记号与 PPT 第 10 页弱式对应：

1. 相场变量  
- `phi`：固相序参量（液相 0，固相 1）  
- `yeta`：孪晶序参量（仅在固相存在）  
- `cMg`：归一化镁离子浓度（液相 0，固相 1）  
- `epspeq`：等效塑性应变累计

2. 归一化浓度定义与初值（本代码已按此实现）  
- `c_l_eq_norm = 0`  
- `c_s_eq_norm = 1`  
- 初始：液相 `cMg=0`，固相 `cMg=1`，界面平滑过渡  
这与您指出的“液相0、固相1”一致。
注意：这是**初始条件**；随腐蚀/扩散推进，液相中的 `cMg` 会因溶解与扩散而升高，不应被强制长期固定为0。

3. 腐蚀相场驱动力（与 PPT 的 `M` 项一致结构）  
- `M = A*(cMg - h(phi)*(c_s_eq_norm-c_l_eq_norm)-c_l_eq_norm)*(c_s_eq_norm-c_l_eq_norm)*h'(phi) - omega*g'(phi) - 0.5*h'(phi)*(e:sigma)`  
- 时间推进：`d(phi)/dt = -L_phi * M`

4. cMg 扩散方程（与 PPT 弱式中 cMg 项对应）  
- `d(cMg)/dt = div( D(phi) * ( grad(cMg) + h'(phi)*(c_l_eq_norm-c_s_eq_norm)*grad(phi) ) )`  
- 其中 `D(phi)=D_s*h(phi) + D_l*(1-h(phi))`

5. yeta 仅存在于固相  
- 梯度项采用 `h(phi)` 加权  
- 演化后强制 `yeta <- yeta * h(phi)`  
因此液相区域的 yeta 被约束到 0，避免液相孪晶伪影。

6. 力学方程  
- `div(sigma)=0`  
- `sigma = h(phi) * C : (eps - eps_p - eps_twin)`  
保持与腐蚀/孪晶场同步耦合。

## 10. 正式对照算例（按物理时间）

新增脚本：`scripts/run_formal_comparison.py`  
用途：自动运行“纯物理 vs ML”两条长步长算例并输出性能/精度报告。

```powershell
.\.venv_gpu\Scripts\python scripts/run_formal_comparison.py --config configs/notch_case.yaml --device cuda --dt-s 5e-5 --total-time-s 0.08 --save-interval-s 0.08 --mixed-precision --report-json artifacts/reports/formal_1600_report.json --report-md artifacts/reports/formal_1600_report.md
```

新增行为：
- 计算过程中实时输出可视化进度条
- 同步输出在线损失（`loss_solid/loss_eta/loss_sigma/loss_epspeq/loss_phi_mae/loss_c_mae`）
- 计算结束自动输出 Physics 与 ML 两套最终云图

## 11. 10x 提速路线（本轮推荐）

本轮默认推荐“高精度加速物理路线”，核心不是放宽物理约束，而是更高效的时间积分：

1. 扩散项：从固定显式子步改为 STS（Super-Time-Stepping）  
2. 力学项：固定子迭代改为残差自适应提前收敛  
3. 时间步：在稳定与精度校核通过后，提高到 `dt = 0.005 s`

对应配置：`configs/half_half_highres_fast_physics.yaml`

### 11.1 关键新参数

- `numerics.diffusion_integrator`: `sts`
- `numerics.diffusion_sts_nu`: `5e-4`
- `numerics.diffusion_sts_max_stages`: `96`
- `numerics.mechanics_adaptive_substeps`: `true`
- `numerics.mechanics_min_substeps`: `2`
- `numerics.mechanics_residual_tol`: `80.0`
- `numerics.mechanics_residual_rel_tol`: `0.06`

### 11.2 5 s 正式试算命令（推荐）

```powershell
.\.venv_gpu\Scripts\python scripts/run_notched_case.py --config configs/half_half_highres_fast_physics.yaml --dt-s 0.005 --total-time-s 5 --save-interval-s 1.0 --device cuda --mixed-precision --disable-ml --progress --progress-every 100
```

### 11.3 0.5 s 速度/精度对照命令（10x 验证）

```powershell
.\.venv_gpu\Scripts\python scripts/run_formal_comparison.py --config configs/half_half_highres_fast_ml.yaml --dt-s 0.005 --total-time-s 0.5 --save-interval-s 0.5 --device cuda --mixed-precision --case-tag fastml_retrained_0p5s --report-json artifacts/reports/fastml_retrained_0p5s_report.json --report-md artifacts/reports/fastml_retrained_0p5s_report.md
```

说明：上述命令用于对照 ML 分支状态；默认正式计算仍建议使用 `fast_physics`（准确性优先）。

### 11.4 本轮 10x 验证结果

- 报告：`artifacts/reports/fast_physics_vs_baseline_0p5s_nu5e4.json`
- 摘要：
  - 基线（`dt=0.001`）耗时：`88.93 s`
  - 新方案（`dt=0.005`）耗时：`6.07 s`
  - 加速比：`14.64x`
  - 终态误差：`phi MAE=4.60e-09`，`cMg MAE=9.28e-04`，`eta MAE=0`，`epspeq MAE=6.73e-07`

### 11.5 自动校准“安全快步长”（新增）

新增脚本：`scripts/calibrate_fast_dt.py`  
用途：在给定精度阈值下自动选择最快 `dt`，避免手工反复试算。

```powershell
.\.venv_gpu\Scripts\python scripts/calibrate_fast_dt.py --baseline-config configs/half_half_highres_ml_pure.yaml --fast-config configs/half_half_highres_fast_physics.yaml --baseline-dt-s 0.001 --dt-candidates-s 0.005,0.0075,0.01 --total-time-s 0.5 --device cuda --mixed-precision --c-mae-max 0.002 --phi-mae-max 1e-4 --epspeq-mae-max 1e-4 --report-json artifacts/reports/dt_calibration_report.json
```

本轮输出：`artifacts/reports/dt_calibration_report.json`  
推荐结果：`dt = 0.005 s`（通过精度阈值且速度最快）。

### 11.6 求解器内部性能统计（新增）

`run_notched_case.py` 输出 JSON 新增 `solver_stats`：

- `mech_predict_solve`
- `mech_correct_solve`
- `mech_correct_skipped_elastic`

用于量化力学预测-校正阶段的实际开销与弹性捷径触发情况。

### 11.7 机器学习与加速白皮书（新增）

已新增专题文档：`docs/机器学习与加速原理详解.md`  
包含以下内容：

- ML 数据构造、残差学习、门控与回退策略
- TinyUNet 与 FNO2D 架构细节
- GPU 与算法加速原理（STS、自适应力学、步长校准）
- 前沿模型启用命令与实测推理基准

### 11.8 新增前沿模型族（AFNO2D / DW-UNet）

本轮在原有 `tiny_unet`、`fno2d` 基础上新增：

- `afno2d`：轻量自适应傅里叶算子模型（推荐前沿加速路线）
- `dw_unet`：深度可分离卷积 U-Net（轻量实验路线）

对应配置：

- `configs/half_half_highres_fast_ml_afno.yaml`
- `configs/half_half_highres_fast_ml_dw.yaml`

四模型推理基准报告：

- `artifacts/reports/surrogate_arch_benchmark_4models.json`

在当前机器（RTX3060，512x1024）上，`afno2d` 轻量参数组合为最快。

可复现实测命令：

```powershell
.\.venv_gpu\Scripts\python scripts/benchmark_surrogate_models.py --device cuda --batch-size 1 --height 512 --width 1024 --warmup 15 --iters 60 --channels-last --architectures tiny_unet,dw_unet,fno2d,afno2d --tiny-hidden 32 --dw-hidden 24 --dw-depth 2 --fno-width 16 --fno-modes-x 12 --fno-modes-y 8 --fno-depth 3 --afno-width 12 --afno-modes-x 8 --afno-modes-y 6 --afno-depth 2 --afno-expansion 1.25
```

## 12. 新增三重物理门控与自适应 Rollout（2026-02-11）

本轮在 `simulator.py` 中把 surrogate 的有效性判定升级为三重门控：

1. **PDE 残差门控**：`phi/c/eta/mechanics` 四类残差分别判定
2. **能量门控**：限制离散自由能的异常上升
3. **不确定性门控**：输入微扰多样本估计 surrogate 局部敏感度

并新增 **自适应 rollout**：

- 连续接受后自动增大 `rollout_every`（提高加速比）
- 连续拒绝后自动减小 `rollout_every`（提高稳健性）

### 12.1 关键配置项（`ml`）

```yaml
enable_pde_residual_gate: true
pde_residual_phi_abs_max: 0.08
pde_residual_c_abs_max: 0.08
pde_residual_eta_abs_max: 0.08
pde_residual_mech_abs_max: 120.0

enable_energy_gate: true
energy_abs_increase_max: 0.05
energy_rel_increase_max: 0.002

enable_uncertainty_gate: false
uncertainty_samples: 3
uncertainty_jitter_std: 0.0005
uncertainty_gate: 0.025

adaptive_rollout: true
rollout_min_every: 1
rollout_max_every: 8
rollout_success_streak_to_increase: 6
rollout_reject_streak_to_decrease: 2
```

### 12.2 进度可视化新增字段

运行进度行新增：

- `F`：当前离散自由能
- `Rphi/Rc/Reta/Rmech`：四类残差
- `roll`：当前动态 rollout 间隔

### 12.3 训练一致化更新

`train_surrogate.py` 的物理损失已更新为：

- 质量守恒按 `h(phi)*cMg` 统计
- 力学残差中引入孪晶本征应变项

对应专项报告：`docs/本轮优化执行报告_20260211.md`

## 13. 力学加载模式显式化（eigenstrain / dirichlet_x）

本轮新增 `mechanics.loading_mode`，用于明确外加载荷表达：

- `eigenstrain`：沿用原有宏观应变项 `external_strain_x`
- `dirichlet_x`：改为位移边界加载（左端 `ux=0`，右端 `ux=u_right`）

新增参数：

- `mechanics.loading_mode`
- `mechanics.dirichlet_right_displacement_um`

说明：

- 当 `dirichlet_right_displacement_um < 0` 时，自动取 `external_strain_x * lx_um`
- 位移边界与线性系统向量约束已分离，避免在 Krylov 残差向量中误施加位移常值

示例（位移边界加载）：

```yaml
mechanics:
  loading_mode: dirichlet_x
  external_strain_x: 0.001
  dirichlet_right_displacement_um: -1.0
```

对照基准脚本：

```powershell
python scripts/benchmark_loading_modes.py --config configs/notch_case.yaml --dt-s 1e-4 --total-time-s 1e-3 --save-interval-s 1e-3 --device cpu --disable-torch-compile --report-json artifacts/reports/loading_mode_benchmark_20260211.json
```

## 附录：本轮新增关键参数（边界与自适应力学）

### 1) 标量边界条件

配置项：`numerics.scalar_bc`

可选值：

- `neumann`：零法向梯度/零通量（默认）
- `periodic`：周期边界（当前仅建议用于均匀网格）
- `dirichlet0`：零值 Dirichlet

示例（YAML）：

```yaml
numerics:
  scalar_bc: neumann
```

### 2) 力学自适应触发阈值

配置项：

- `numerics.mechanics_trigger_phi_max_delta`
- `numerics.mechanics_trigger_eta_max_delta`

作用：当 `mechanics_update_every > 1` 时，若 `phi/eta` 相对上次力学求解变化超过阈值，则提前触发力学更新。

示例（YAML）：

```yaml
numerics:
  mechanics_update_every: 8
  mechanics_trigger_phi_max_delta: 5.0e-4
  mechanics_trigger_eta_max_delta: 2.0e-4
```

### 3) 训练新增损失权重

命令行参数：`--loss-pde-weight`

作用：训练时加入 `phi/c/eta` 离散 PDE 残差约束，减小长时 rollout 漂移。

示例：

```powershell
python scripts/train_surrogate.py --config configs/notch_case.yaml --device cuda --streaming --loss-pde-weight 0.05
```

### 4) 标量隐式线性求解器（新增）

配置项：`numerics.scalar_linear_solver`

可选值：

- `auto`：先 PCG，不收敛自动回退 BiCGStab（推荐）
- `pcg`：仅用 PCG
- `bicgstab`：仅用 BiCGStab

示例（YAML）：

```yaml
numerics:
  scalar_linear_solver: auto
```

说明：

- 该选项作用于相场/扩散的标量隐式方程求解。  
- 运行统计中可看到：
  - `scalar_pcg_calls` / `scalar_pcg_converged`
  - `scalar_bicgstab_calls` / `scalar_bicgstab_converged`
  - `scalar_solver_fallback`

### 5) 力学边界按轴配置（新增）

配置项：

- `mechanics.mechanics_bc`（全局默认）
- `mechanics.mechanics_bc_x`（x 轴覆盖）
- `mechanics.mechanics_bc_y`（y 轴覆盖）

可选值：`neumann` / `periodic` / `dirichlet0`

示例（YAML）：

```yaml
mechanics:
  mechanics_bc: neumann
  mechanics_bc_x: dirichlet0
  mechanics_bc_y: neumann
```

说明：

- 若 `mechanics_bc_x/y` 为空，则回退到 `mechanics_bc`；
- 力学残差计算与力学梯度/散度均使用该套 BC。

### 6) surrogate 位置通道与位移硬投影（新增）

配置项：

- `ml.surrogate_add_coord_features`
- `ml.surrogate_enforce_displacement_projection`

作用：

- 对 `tiny_unet/dw_unet` 自动加入坐标通道 `(x/L, y/L)`；
- surrogate 输出后强制满足位移约束：
  - `ux(left)=0`
  - `ux(right)=u_right`（Dirichlet 加载模式）
  - `uy(0,0)=0`

示例（YAML）：

```yaml
ml:
  surrogate_add_coord_features: true
  surrogate_enforce_displacement_projection: true
```

### 7) cMg 质量门控与质量投影（新增）

配置项（门控）：

- `ml.enable_mass_gate`
- `ml.mass_abs_delta_max`
- `ml.mass_rel_delta_max`

配置项（投影）：

- `numerics.concentration_mass_projection`
- `numerics.concentration_mass_projection_iters`
- `ml.enforce_mass_projection_on_accept`

示例（YAML）：

```yaml
numerics:
  concentration_mass_projection: true
  concentration_mass_projection_iters: 2
ml:
  enable_mass_gate: true
  mass_abs_delta_max: 1.0e-4
  mass_rel_delta_max: 1.0e-4
  enforce_mass_projection_on_accept: false
```

对应统计量：

- `ml_reject_mass`
- `mass_projection_applied`
